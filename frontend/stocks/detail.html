<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <title>ÈäòÊüÑÂàÜÊûê„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f1117;
      --card: #1a1d2e;
      --card2: #22263a;
      --accent: #4a9eff;
      --accent2: #7c5cfc;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #f59e0b;
      --text: #e2e8f0;
      --muted: #8892a4;
      --border: #2d3252
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    html,
    body {
      height: 100%;
      overflow: hidden
    }

    /* Custom scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(136, 146, 164, .25) transparent
    }

    *::-webkit-scrollbar {
      width: 6px;
      height: 6px
    }

    *::-webkit-scrollbar-track {
      background: transparent
    }

    *::-webkit-scrollbar-thumb {
      background: rgba(136, 146, 164, .25);
      border-radius: 3px
    }

    *::-webkit-scrollbar-thumb:hover {
      background: rgba(136, 146, 164, .45)
    }

    *::-webkit-scrollbar-corner {
      background: transparent
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
      font-size: 17px;
      line-height: 1.7
    }

    /* Shell */
    .shell {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 10px 14px
    }

    /* Header bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      flex-shrink: 0;
      margin-bottom: 8px
    }

    .back-btn {
      color: var(--accent);
      text-decoration: none;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .back-btn:hover {
      opacity: .8
    }

    #topBarStatus {
      display: flex;
      align-items: center;
      gap: 8px
    }

    /* 2-column layout */
    .layout {
      display: flex;
      gap: 12px;
      flex: 1;
      min-height: 0
    }

    /* Left panel */
    .left-panel {
      width: 340px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: auto
    }

    .left-panel .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px
    }

    .company-name {
      font-size: 20px;
      font-weight: 800;
      color: #fff;
      margin-bottom: 4px
    }

    .company-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px
    }

    .catchcopy {
      font-size: 14px;
      color: #94a3c8;
      font-style: italic;
      line-height: 1.6;
      padding: 12px;
      background: var(--card2);
      border-radius: 6px;
      margin-bottom: 8px
    }

    /* Score circle (compact) */
    .score-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 6px 0
    }

    .score-circle {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0
    }

    .score-inner {
      width: 78px;
      height: 78px;
      border-radius: 50%;
      background: var(--card);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center
    }

    .score-val {
      font-size: 28px;
      font-weight: 800;
      color: #fff;
      line-height: 1
    }

    .score-max {
      font-size: 11px;
      color: var(--muted)
    }

    .score-info .rank-badge {
      display: inline-block;
      padding: 3px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 5px
    }

    /* Mini metrics */
    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(45, 50, 82, .4);
      font-size: 15px
    }

    .metric-row:last-child {
      border-bottom: none
    }

    .metric-label {
      color: var(--muted);
      font-size: 13px
    }

    .metric-val {
      font-weight: 700;
      font-size: 16px
    }

    .metric-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700
    }

    .m-good {
      background: rgba(34, 197, 94, .1);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, .2)
    }

    .m-warn {
      background: rgba(245, 158, 11, .1);
      color: var(--yellow);
      border: 1px solid rgba(245, 158, 11, .2)
    }

    .m-bad {
      background: rgba(239, 68, 68, .1);
      color: var(--red);
      border: 1px solid rgba(239, 68, 68, .2)
    }

    /* Data source badges */
    .src-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px
    }

    .src-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 8px;
      background: var(--card2);
      color: var(--muted);
      border: 1px solid var(--border)
    }

    /* Right panel */
    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0
    }

    /* Tabs */
    .tab-bar {
      display: flex;
      gap: 2px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      margin-bottom: 6px
    }

    .tab-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 15px;
      font-weight: 600;
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all .15s
    }

    .tab-btn:hover {
      color: var(--text)
    }

    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent)
    }

    .tab-content {
      display: none;
      flex: 1;
      min-height: 0;
      overflow: auto;
      padding: 4px
    }

    .tab-content.active {
      display: block
    }

    /* Cards */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 10px
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 10px
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 14px;
      font-size: 12px;
      font-weight: 600
    }

    .badge-blue {
      background: rgba(74, 158, 255, .12);
      color: var(--accent);
      border: 1px solid rgba(74, 158, 255, .25)
    }

    .badge-green {
      background: rgba(34, 197, 94, .12);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, .25)
    }

    .badge-purple {
      background: rgba(124, 92, 252, .12);
      color: #a78bfa;
      border: 1px solid rgba(124, 92, 252, .25)
    }

    .badge-gray {
      background: rgba(136, 146, 164, .12);
      color: var(--muted);
      border: 1px solid rgba(136, 146, 164, .25)
    }

    .badge-orange {
      background: rgba(245, 158, 11, .12);
      color: var(--yellow);
      border: 1px solid rgba(245, 158, 11, .25)
    }

    .badge-red {
      background: rgba(239, 68, 68, .12);
      color: var(--red);
      border: 1px solid rgba(239, 68, 68, .25)
    }

    /* Biz tab */
    .biz-text {
      font-size: 14px;
      line-height: 1.8;
      color: #c8cfe0
    }

    .biz-text p {
      margin-bottom: 8px
    }

    .seg-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px
    }

    .seg-card {
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px
    }

    .seg-card h4 {
      font-size: 15px;
      color: #fff;
      margin-bottom: 6px
    }

    .seg-card p {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.6
    }

    .seg-card.highlight {
      background: rgba(34, 197, 94, .04);
      border-color: rgba(34, 197, 94, .2)
    }

    .seg-card.highlight h4 {
      color: var(--green)
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px
    }

    /* Charts */
    .chart-container {
      position: relative;
      height: 220px
    }

    .per-chart-container {
      position: relative;
      height: 200px
    }

    /* Valuation table */
    .val-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px
    }

    .val-table th {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      color: var(--muted);
      font-size: 13px
    }

    .val-table td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(45, 50, 82, .4)
    }

    .val-good {
      color: var(--green)
    }

    .val-warn {
      color: var(--yellow)
    }

    .val-bad {
      color: var(--red)
    }

    /* Posi/Nega */
    .pn-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px
    }

    .posi-card,
    .nega-card {
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 8px
    }

    .posi-card {
      background: rgba(34, 197, 94, .04);
      border: 1px solid rgba(34, 197, 94, .15)
    }

    .nega-card {
      background: rgba(239, 68, 68, .04);
      border: 1px solid rgba(239, 68, 68, .15)
    }

    .pn-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 6px
    }

    .posi-card .pn-title {
      color: var(--green)
    }

    .nega-card .pn-title {
      color: var(--red)
    }

    .pn-explain {
      font-size: 14px;
      color: #94a3c8;
      line-height: 1.6
    }

    .pn-source {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px
    }

    .impact {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 6px;
      margin-left: 4px;
      font-weight: 700
    }

    .impact-high {
      background: rgba(245, 158, 11, .12);
      color: var(--yellow);
      border: 1px solid rgba(245, 158, 11, .2)
    }

    .impact-mid {
      background: rgba(74, 158, 255, .12);
      color: var(--accent);
      border: 1px solid rgba(74, 158, 255, .2)
    }

    .impact-low {
      background: rgba(136, 146, 164, .12);
      color: var(--muted);
      border: 1px solid rgba(136, 146, 164, .2)
    }

    /* Verdict */
    .verdict-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px
    }

    .verdict-item {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      margin-bottom: 8px;
      font-size: 15px;
      line-height: 1.6
    }

    .verdict-item .icon {
      flex-shrink: 0
    }

    .summary-box {
      background: rgba(74, 158, 255, .06);
      border: 1px solid rgba(74, 158, 255, .15);
      border-radius: 8px;
      padding: 18px;
      font-size: 15px;
      line-height: 1.8
    }

    .summary-box h4 {
      font-size: 14px;
      color: var(--accent);
      margin-bottom: 6px
    }

    /* Axis bars */
    .axis-item {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px
    }

    .axis-label {
      font-size: 12px;
      color: var(--muted);
      width: 44px;
      text-align: right;
      flex-shrink: 0
    }

    .axis-bar-wrap {
      flex: 1;
      height: 8px;
      background: var(--card2);
      border-radius: 3px;
      overflow: hidden
    }

    .axis-bar {
      height: 100%;
      border-radius: 3px;
      transition: width .6s ease
    }

    .axis-val {
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      width: 22px;
      text-align: right
    }

    .axis-rank {
      font-size: 11px;
      color: var(--muted)
    }

    /* Status selector */
    .status-selector {
      position: relative;
      display: inline-block
    }

    .status-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card2);
      color: var(--text);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer
    }

    .status-btn:hover {
      border-color: var(--accent)
    }

    .st-interested {
      background: rgba(245, 158, 11, .1);
      color: var(--yellow);
      border-color: rgba(245, 158, 11, .25)
    }

    .st-watching {
      background: rgba(74, 158, 255, .1);
      color: var(--accent);
      border-color: rgba(74, 158, 255, .25)
    }

    .st-archived {
      background: rgba(136, 146, 164, .1);
      color: var(--muted);
      border-color: rgba(136, 146, 164, .25)
    }

    .status-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      background: #1a1d2e;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      min-width: 160px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .5);
      display: none;
      z-index: 300
    }

    .status-dropdown.open {
      display: block
    }

    .status-option {
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s;
      white-space: nowrap
    }

    .status-option:hover {
      background: rgba(255, 255, 255, .05)
    }

    .status-option.active {
      background: rgba(74, 158, 255, .08)
    }

    .status-toast {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 6px
    }

    .status-saving {
      background: rgba(74, 158, 255, .1);
      color: var(--accent)
    }

    /* Add button */
    .wl-add-btn {
      padding: 5px 14px;
      border-radius: 8px;
      border: 1px solid rgba(34, 197, 94, .3);
      background: rgba(34, 197, 94, .12);
      color: var(--green);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all .15s
    }

    .wl-add-btn:hover {
      background: rgba(34, 197, 94, .2)
    }

    .wl-add-btn.added {
      background: rgba(34, 197, 94, .15);
      border-color: rgba(34, 197, 94, .3);
      cursor: default
    }

    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--muted)
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite;
      margin-bottom: 8px
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    .error-box {
      text-align: center;
      padding: 40px;
      color: var(--muted)
    }

    .error-box h2 {
      font-size: 16px;
      color: var(--red);
      margin-bottom: 8px
    }

    /* Responsive */
    @media(max-width:768px) {
      .layout {
        flex-direction: column
      }

      .left-panel {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap
      }

      .pn-grid,
      .verdict-grid,
      .seg-grid {
        grid-template-columns: 1fr
      }
    }
  </style>
</head>

<body>

  <div class="shell">
    <!-- Top bar -->
    <div class="top-bar">
      <a href="../index.html" class="back-btn">‚Üê „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</a>
      <div id="topBarStatus"></div>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div>„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</div>
    </div>

    <!-- Error -->
    <div id="error" style="display:none">
      <div class="error-box">
        <h2>‚ö†Ô∏è „Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</h2>
        <p id="errorMsg"></p>
        <p style="margin-top:12px"><a href="../index.html" style="color:var(--accent)">‚Üê „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</a></p>
      </div>
    </div>

    <!-- Main (generated by JS) -->
    <div id="main" style="display:none"></div>
  </div>

  <script>
    const GITHUB_RAW = 'https://raw.githubusercontent.com/bi-al1/stok-analyzer/master';
    const RENDER_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:8000' : 'https://stock-dashboard-rif1.onrender.com';
    const params = new URLSearchParams(location.search);
    const code = params.get('code');
    if (!code) { showError('URL„Å´ ?code=XXXX „ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', ''); } else { document.title = `${code} ÂàÜÊûê`; loadStock(code); }

    async function loadStock(code) {
      try {
        const ts = Date.now();
        const [stockRes, wlRes] = await Promise.all([
          fetch(`${GITHUB_RAW}/webapp/data/stocks/${code.toUpperCase()}.json?_=${ts}`),
          fetch(`${RENDER_BASE}/api/watchlist`),
        ]);
        if (!stockRes.ok) throw new Error(`HTTP ${stockRes.status}`);
        const d = await stockRes.json();
        let wlEntry = null;
        if (wlRes.ok) { const wl = await wlRes.json(); wlEntry = (wl.watchlist || []).find(w => w.code === code.toUpperCase()) ?? null; }
        render(d, wlEntry);
      } catch (e) { showError(`ÈäòÊüÑ„Ç≥„Éº„Éâ "${code}" „ÅÆ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ`, e.message); }
    }

    function showError(msg, detail) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('errorMsg').textContent = msg + (detail ? ` (${detail})` : '');
    }

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
    function rankColor(r) { return { SSS: '#22c55e', SS: '#4ade80', S: '#86efac', 'A+': '#4a9eff', A: '#60a5fa', 'B+': '#a78bfa', B: '#c4b5fd', C: '#f59e0b', D: '#fb923c', E: '#ef4444', F: '#ef4444' }[r] || '#8892a4'; }
    function axisBarColor(r) { return ['SSS', 'SS', 'S'].includes(r) ? '#22c55e' : ['A+', 'A'].includes(r) ? '#4a9eff' : ['B+', 'B'].includes(r) ? '#a78bfa' : r === 'C' ? '#f59e0b' : '#ef4444'; }
    function metricBadge(val, good, warn) { if (val == null) return '<span class="metric-badge" style="color:var(--muted)">N/A</span>'; const cls = typeof good === 'function' ? good(val) ? 'm-good' : warn(val) ? 'm-warn' : 'm-bad' : val >= good ? 'm-good' : val >= warn ? 'm-warn' : 'm-bad'; const label = cls === 'm-good' ? 'ËâØÂ•Ω' : cls === 'm-warn' ? 'Ê≥®ÊÑè' : 'Âç±Èô∫'; return `<span class="metric-badge ${cls}">${label}</span>`; }
    function switchTab(name) { document.querySelectorAll('.dtab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === name)); document.querySelectorAll('.dtab').forEach(t => t.classList.toggle('active', t.id === 'dtab-' + name)); }

    // ‚îÄ‚îÄ Main render ‚îÄ‚îÄ
    function render(d, wlEntry) {
      const c = d.company, scores = d.scores, fin = d.financials, price = d.price, biz = d.business, verdict = d.verdict;
      const positives = d.positives || [], negatives = d.negatives || [], priceHistory = d.price_history || [];
      document.title = `${c.name}Ôºà${c.code}Ôºâ`;

      const scoreColor = rankColor(scores.total_rank);
      const scoreDeg = Math.min((scores.total_score / 10) * 360, 360);

      // Axis bars
      const axisKeys = [{ key: 'growth', label: 'ÊàêÈï∑' }, { key: 'stability', label: 'ÂÆâÂÆö' }, { key: 'profitability', label: 'ÂèéÁõä' }, { key: 'capacity', label: '‰ΩôÂäõ' }, { key: 'innovation', label: 'Êñ∞Ë¶è' }];
      const axisBars = axisKeys.map(ax => {
        const val = scores.axes?.[ax.key]?.score ?? 0, rank = scores.axes?.[ax.key]?.rank ?? 'F';
        return `<div class="axis-item"><span class="axis-label">${ax.label}</span><div class="axis-bar-wrap"><div class="axis-bar" style="width:${(val / 10 * 100).toFixed(0)}%;background:${axisBarColor(rank)}"></div></div><span class="axis-val">${val.toFixed(1)}</span></div>`;
      }).join('');

      // Source badges
      const srcBadges = [d.has_yfinance ? 'üìä yfinance' : '', d.has_websearch ? 'üîç WebSearch' : '', d.has_kabumart ? 'üìå KabuMart' : ''].filter(Boolean).map(s => `<span class="src-badge">${s}</span>`).join('');

      // Segments
      const segCards = (biz.segments || []).map(s => `<div class="seg-card${s.highlight ? ' highlight' : ''}">${s.icon ? `<h4>${s.icon} ${s.name}</h4>` : `<h4>${s.name}</h4>`}<p>${s.description || ''}</p></div>`).join('');
      const tagBadges = (biz.tags || []).map(t => `<span class="badge badge-blue">${t}</span>`).join('');

      // PER metric ‚Äî per_history„ÅÆÊúÄÊñ∞ÂÄ§„ÇíÂÑ™ÂÖàÔºàPERÊõ¥Êñ∞Âæå„ÅØÊúÄÊñ∞„ÅåÂèçÊò†„Åï„Çå„ÇãÔºâ
      const latestPer = wlEntry?.per_history?.length ? wlEntry.per_history[wlEntry.per_history.length - 1].per : fin.per;
      let perBadge = metricBadge(latestPer, v => v > 0 && v < 15, v => v > 0 && v < 25);
      if (latestPer != null && latestPer < 0) perBadge = '<span class="metric-badge m-bad">Ëµ§Â≠ó</span>';

      // Valuation table
      let valTable = [...(fin.valuation_table || [])];
      if (fin.roe != null && !valTable.some(r => r.label.includes('ROE'))) {
        let insertIdx = valTable.findIndex(r => r.label.includes('PBR'));
        if (insertIdx === -1) insertIdx = valTable.findIndex(r => r.label.includes('PER'));
        const roeRow = {
          label: 'ROEÔºàËá™Â∑±Ë≥áÊú¨Âà©ÁõäÁéáÔºâ',
          value: fin.roe.toFixed(1) + '%',
          benchmark: 'ÁõÆÂÆâ: 10%‰ª•‰∏ä',
          status: fin.roe >= 10 ? 'good' : (fin.roe >= 5 ? 'warn' : 'bad'),
          badge: fin.roe >= 10 ? 'È´òROE' : (fin.roe >= 5 ? 'Âπ≥ÂùáÁöÑ' : '‰ΩéÊ∞¥Ê∫ñ'),
          badge_color: fin.roe >= 10 ? 'green' : (fin.roe >= 5 ? 'orange' : 'red'),
          note: fin.roe_note || 'Ëá™Â∑±Ë≥áÊú¨ÔºàÊ†™‰∏ª„ÅÆ„ÅäÈáëÔºâ„Çí‰Ωø„Å£„Å¶„Å©„Çå„Å†„ÅëÂäπÁéá„Çà„ÅèÂà©Áõä„ÇíÁîü„ÅøÂá∫„Åó„Å¶„ÅÑ„Çã„Åã„ÇíÁ§∫„Åó„Åæ„Åô„ÄÇ'
        };
        if (insertIdx !== -1) valTable.splice(insertIdx + 1, 0, roeRow);
        else valTable.push(roeRow);
      }

      const valRows = valTable.map(row => {
        const cls = row.status === 'good' ? 'val-good' : row.status === 'warn' ? 'val-warn' : row.status === 'bad' ? 'val-bad' : '';
        const badgeHtml = row.badge ? `<span class="badge badge-${row.badge_color || 'gray'}" style="font-size:11px">${row.badge}</span>` : '‚Äî';
        let valText = row.value;
        if (row.label.includes('PER')) valText = latestPer != null ? `${latestPer}ÂÄç` : 'N/A';
        return `<tr><td>${row.label}</td><td class="${cls}">${valText}</td><td>${row.benchmark || '‚Äî'}</td><td>${badgeHtml}</td><td style="font-size:13px;color:var(--muted)">${row.note || ''}</td></tr>`;
      }).join('');

      // Posi/Nega
      const posiCards = positives.map(i => `<div class="posi-card"><div class="pn-title">${i.title} <span class="impact impact-${(i.impact || 'mid').toLowerCase()}">${(i.impact || 'MID').toUpperCase()}</span></div><div class="pn-explain">üí¨ ${i.explain || ''}</div><div class="pn-source">${i.source || ''}</div></div>`).join('');
      const negaCards = negatives.map(i => `<div class="nega-card"><div class="pn-title">${i.title} <span class="impact impact-${(i.impact || 'mid').toLowerCase()}">${(i.impact || 'MID').toUpperCase()}</span></div><div class="pn-explain">üí¨ ${i.explain || ''}</div><div class="pn-source">${i.source || ''}</div></div>`).join('');

      // Verdict
      const strengthItems = (verdict.strengths || []).map(s => `<div class="verdict-item"><span class="icon">${s.icon || 'üí™'}</span><span><strong>${s.title}</strong>Ôºö${s.text}</span></div>`).join('');
      const riskItems = (verdict.risks || []).map(r => `<div class="verdict-item"><span class="icon">${r.icon || '‚ö†Ô∏è'}</span><span><strong>${r.title}</strong>Ôºö${r.text}</span></div>`).join('');
      const links = (d.links || []).map(l => `<a href="${l.url}" target="_blank" style="color:var(--accent);font-size:11px">${l.label}</a>`).join(' / ');

      const html = `
<div class="layout">
  <!-- LEFT PANEL -->
  <div class="left-panel">
    <div class="card">
      <div class="company-name">${c.name}</div>
      <div class="company-meta">
        <span class="badge badge-blue">${c.code}</span>
        <span class="badge badge-purple">${c.industry || ''}</span>
        <span class="badge badge-gray">${c.market || ''}</span>
        ${c.extra_badge ? `<span class="badge badge-orange">${c.extra_badge}</span>` : ''}
      </div>
      ${biz.catchcopy ? `<div class="catchcopy">${biz.catchcopy}</div>` : ''}

      <div class="score-wrap">
        <div class="score-circle" style="background:conic-gradient(${scoreColor} 0deg ${scoreDeg}deg, #2d3252 ${scoreDeg}deg 360deg)">
          <div class="score-inner"><div class="score-val">${scores.total_score}</div><div class="score-max">/10</div></div>
        </div>
        <div class="score-info">
          <div class="rank-badge" style="background:${scoreColor}22;color:${scoreColor};border:1px solid ${scoreColor}">${scores.total_rank}</div>
          ${scores.note ? `<div style="font-size:10px;color:var(--muted);margin-top:4px">${scores.note}</div>` : ''}
        </div>
      </div>
      ${axisBars}
    </div>

    <div class="card">
      <div class="metric-row"><span class="metric-label">‰∫àÊÉ≥PER</span><span><span class="metric-val">${latestPer != null ? latestPer + 'ÂÄç' : 'N/A'}</span> ${perBadge}</span></div>
      <div class="metric-row"><span class="metric-label">ROE</span><span><span class="metric-val">${fin.roe != null ? fin.roe.toFixed(1) + '%' : 'N/A'}</span> ${metricBadge(fin.roe, v => v >= 10, v => v >= 5)}</span></div>
      <div class="metric-row"><span class="metric-label">Ëá™Â∑±Ë≥áÊú¨ÊØîÁéá</span><span><span class="metric-val">${fin.equity_ratio != null ? fin.equity_ratio.toFixed(1) + '%' : 'N/A'}</span> ${metricBadge(fin.equity_ratio, v => v >= 40, v => v >= 20)}</span></div>
      ${price.current ? `<div class="metric-row"><span class="metric-label">ÁèæÂú®Ê†™‰æ°</span><span class="metric-val">¬•${price.current.toLocaleString()}</span></div>` : ''}
    </div>

    <div class="card" style="font-size:10px;color:var(--muted)">
      <div>üìÖ Ë™øÊüªÊó•: ${c.analyzed_date || '‚Äî'}</div>
      <div class="src-badges">${srcBadges}</div>
      ${links ? `<div style="margin-top:6px">${links}</div>` : ''}
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">
    <div class="tab-bar">
      <button class="tab-btn dtab-btn active" data-tab="biz" onclick="switchTab('biz')">‰∫ãÊ•≠ÂÜÖÂÆπ</button>
      <button class="tab-btn dtab-btn" data-tab="fin" onclick="switchTab('fin')">Ë≤°Âãô„Éª„ÉÅ„É£„Éº„Éà</button>
      <button class="tab-btn dtab-btn" data-tab="pn" onclick="switchTab('pn')">„Éù„Ç∏„Éª„Éç„Ç¨</button>
      <button class="tab-btn dtab-btn" data-tab="verdict" onclick="switchTab('verdict')">Á∑èÂêàË©ï‰æ°</button>
    </div>

    <!-- Tab: Business -->
    <div class="tab-content dtab active" id="dtab-biz">
      <div class="card">
        <div class="card-title">üè¢ „Åì„ÅÆ‰ºöÁ§æ„ÅØ‰Ωï„Çí„Åó„Å¶„ÅÑ„ÇãÔºü</div>
        <div class="biz-text">${(biz.paragraphs || []).map(p => `<p>${p}</p>`).join('')}</div>
        <div class="tags">${tagBadges}</div>
      </div>
      ${segCards ? `<div class="card"><div class="card-title">üìä ‰∫ãÊ•≠„Çª„Ç∞„É°„É≥„Éà</div><div class="seg-grid">${segCards}</div></div>` : ''}
    </div>

    <!-- Tab: Financials & Charts -->
    <div class="tab-content dtab" id="dtab-fin">
      ${valRows ? `<div class="card"><div class="card-title">üìä „Éê„É™„É•„Ç®„Éº„Ç∑„Éß„É≥Ë©≥Á¥∞</div><table class="val-table"><thead><tr><th>ÊåáÊ®ô</th><th>ÂÄ§</th><th>ÁõÆÂÆâ</th><th>Ë©ï‰æ°</th><th>„Å§„Åæ„ÇäÔºü</th></tr></thead><tbody>${valRows}</tbody></table></div>` : ''}
      ${priceHistory.length > 0 ? `<div class="card"><div class="card-title">üìà Ê†™‰æ°„ÉÅ„É£„Éº„ÉàÔºàÈÅéÂéª1Âπ¥ÈñìÔºâ${price.current ? ` ‚Äî ÁèæÂú® ¬•${price.current.toLocaleString()}` : ''}</div><div class="chart-container"><canvas id="priceChart"></canvas></div></div>` : ''}
      ${wlEntry?.per_history?.length >= 1 ? `<div class="card"><div class="card-title">üìâ ‰∫àÊÉ≥PER Êé®Áßª</div><div class="per-chart-container"><canvas id="perChart"></canvas></div></div>` : ''}
    </div>

    <!-- Tab: Posi/Nega -->
    <div class="tab-content dtab" id="dtab-pn">
      <div class="pn-grid">
        <div><div style="font-size:13px;font-weight:700;color:var(--green);margin-bottom:8px">‚úÖ „Éù„Ç∏„ÉÜ„Ç£„ÉñË¶ÅÁ¥†</div>${posiCards}</div>
        <div><div style="font-size:13px;font-weight:700;color:var(--red);margin-bottom:8px">‚ö†Ô∏è „Éç„Ç¨„ÉÜ„Ç£„ÉñË¶ÅÁ¥†</div>${negaCards}</div>
      </div>
    </div>

    <!-- Tab: Verdict -->
    <div class="tab-content dtab" id="dtab-verdict">
      <div class="verdict-grid">
        <div class="card"><div style="font-size:12px;font-weight:700;color:var(--green);margin-bottom:8px">üí™ „Åì„ÅÆ‰ºöÁ§æ„ÅÆÂº∑„Åø</div>${strengthItems}</div>
        <div class="card"><div style="font-size:12px;font-weight:700;color:var(--red);margin-bottom:8px">‚ö†Ô∏è Ê∞ó„Çí„Å§„Åë„Åü„ÅÑ„É™„Çπ„ÇØ</div>${riskItems}</div>
      </div>
      <div class="summary-box"><h4>üìù ÂàùÂøÉËÄÖÂêë„Åë„Åæ„Å®„ÇÅ</h4><p>${verdict.summary || ''}</p></div>
    </div>
  </div>
</div>`;

      document.getElementById('main').innerHTML = html;
      document.getElementById('loading').style.display = 'none';
      document.getElementById('main').style.display = 'flex';
      document.getElementById('main').style.flex = '1';
      document.getElementById('main').style.minHeight = '0';

      // Watchlist status
      if (wlEntry) { renderStatusSelector(wlEntry, c.code); }
      else { renderAddButton(c, scores, fin); }

      // Draw charts after DOM ready
      requestAnimationFrame(() => {
        if (priceHistory.length > 0) drawPrice(priceHistory, d.ipo_date);
        if (wlEntry?.per_history?.length >= 1) drawPerHistory(wlEntry.per_history);
      });
    }

    // ‚îÄ‚îÄ Watchlist Add Button ‚îÄ‚îÄ
    function renderAddButton(company, scores, fin) {
      const container = document.getElementById('topBarStatus');
      const btn = document.createElement('button');
      btn.className = 'wl-add-btn';
      btn.textContent = 'Ôºã „Ç¶„Ç©„ÉÉ„ÉÅ„É™„Çπ„Éà„Å´ËøΩÂä†';
      container.appendChild(btn);
      const rank = scores?.total_rank ?? '', score = scores?.total_score ?? '';
      const note = rank ? `Á∑èÂêà„Çπ„Ç≥„Ç¢ ${rank} (${score}/10)` : '';
      const per = fin?.per ?? null;
      btn.onclick = async () => {
        btn.textContent = '‚è≥ ËøΩÂä†‰∏≠...'; btn.disabled = true;
        try {
          const body = { code: company.code, name: company.name, note, kabumart_rank: rank };
          if (per != null) body.per = per;
          const res = await fetch(`${RENDER_BASE}/api/watchlist`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
          const json = await res.json();
          if (res.status === 409) { btn.textContent = '‚úÖ ÁôªÈå≤Ê∏à„Åø'; btn.classList.add('added'); }
          else if (!res.ok) throw new Error(json.detail ?? '„Ç®„É©„Éº');
          else { btn.textContent = '‚úÖ ËøΩÂä†„Åó„Åæ„Åó„Åü'; btn.classList.add('added'); }
          setTimeout(() => { container.innerHTML = ''; renderStatusSelector({ status: 'archived' }, company.code); }, 800);
        } catch (e) { btn.textContent = '‚ö†Ô∏è Â§±Êïó'; btn.disabled = false; setTimeout(() => { btn.textContent = 'Ôºã „Ç¶„Ç©„ÉÉ„ÉÅ„É™„Çπ„Éà„Å´ËøΩÂä†'; btn.classList.remove('added'); }, 2000); }
      };
    }

    // ‚îÄ‚îÄ Status Selector ‚îÄ‚îÄ
    const STATUS_MAP = { interested: { label: 'üíõ Á©çÊ•µÊ§úË®é', cls: 'st-interested' }, watching: { label: 'üëÄ Ë¶ÅË¶≥ÂØü', cls: 'st-watching' }, archived: { label: 'üì¶ „Ç¢„Éº„Ç´„Ç§„Éñ', cls: 'st-archived' } };

    function renderStatusSelector(wlEntry, code) {
      const container = document.getElementById('topBarStatus');
      let currentStatus = wlEntry.status || 'archived';
      let sel = document.getElementById('statusSelector');
      let toastEl = document.getElementById('statusToast');
      if (!sel) { sel = document.createElement('div'); sel.className = 'status-selector'; sel.id = 'statusSelector'; container.appendChild(sel); }
      if (!toastEl) { toastEl = document.createElement('span'); toastEl.className = 'status-toast'; toastEl.id = 'statusToast'; toastEl.style.display = 'none'; container.appendChild(toastEl); }
      sel.innerHTML = buildSelectorHTML(currentStatus);
      sel.onclick = e => {
        const btn = e.target.closest('.status-btn'), opt = e.target.closest('.status-option');
        if (btn) { sel.querySelector('.status-dropdown').classList.toggle('open'); return; }
        if (opt) { sel.querySelector('.status-dropdown').classList.remove('open'); const ns = opt.dataset.status; if (ns === currentStatus) return; currentStatus = ns; updateStatus(code, ns, sel, toastEl); }
      };
      if (!sel._outsideClickBound) { sel._outsideClickBound = true; document.addEventListener('click', e => { if (!sel.contains(e.target)) sel.querySelector('.status-dropdown')?.classList.remove('open'); }); }
    }
    function buildSelectorHTML(current) {
      const cur = STATUS_MAP[current] || STATUS_MAP.archived;
      const opts = Object.entries(STATUS_MAP).map(([v, i]) => `<div class="status-option${v === current ? ' active' : ''}" data-status="${v}">${i.label}</div>`).join('');
      return `<button class="status-btn ${cur.cls}">${cur.label} ‚ñæ</button><div class="status-dropdown">${opts}</div>`;
    }
    async function updateStatus(code, newStatus, selEl, toastEl) {
      selEl.querySelector('.status-dropdown').classList.remove('open');
      const oldHTML = selEl.innerHTML;

      // Optimistic update
      selEl.innerHTML = buildSelectorHTML(newStatus);
      toastEl.className = 'status-toast status-saving'; toastEl.textContent = '‰øùÂ≠ò‰∏≠...'; toastEl.style.display = '';

      try {
        const res = await fetch(`${RENDER_BASE}/api/watchlist/status`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code, status: newStatus }) });
        const json = await res.json(); if (!json.ok) throw new Error(json.detail ?? json.error);
        toastEl.style.display = 'none';
      } catch (e) {
        // Revert on Failure
        selEl.innerHTML = oldHTML;
        toastEl.className = 'status-toast err'; toastEl.textContent = `‚ö†Ô∏è ${e.message}`; 
        setTimeout(() => { toastEl.style.display = 'none'; }, 3000); 
      }
    }

    // ‚îÄ‚îÄ Price Chart ‚îÄ‚îÄ
    function drawPrice(priceHistory, ipoDate) {
      const ctx = document.getElementById('priceChart'); if (!ctx) return;
      const labels = priceHistory.map(d => d.date), closes = priceHistory.map(d => d.close);
      new Chart(ctx.getContext('2d'), { type: 'line', data: { labels, datasets: [{ label: 'ÁµÇÂÄ§(ÂÜÜ)', data: closes, borderColor: '#4a9eff', backgroundColor: 'rgba(74,158,255,.08)', fill: true, borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, tension: .3 }] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1a1d2e', borderColor: '#2d3252', borderWidth: 1, titleColor: '#94a3c8', bodyColor: '#e2e8f0', callbacks: { label: ctx => `¬•${ctx.parsed.y.toLocaleString()}` } } }, scales: { x: { ticks: { color: '#8892a4', maxTicksLimit: 8, maxRotation: 0, callback: (v, i) => { const d = labels[i]; return d ? d.slice(2, 7).replace('-', '/') : ''; } }, grid: { color: 'rgba(45,50,82,.5)' } }, y: { ticks: { color: '#8892a4', callback: v => '¬•' + v.toLocaleString() }, grid: { color: 'rgba(45,50,82,.5)' } } } } });
    }

    // ‚îÄ‚îÄ PER History Chart ‚îÄ‚îÄ
    function drawPerHistory(perHistory) {
      const ctx = document.getElementById('perChart'); if (!ctx) return;
      const labels = perHistory.map(h => h.date), values = perHistory.map(h => h.per);
      const pointColors = values.map(v => v == null ? 'rgba(136,146,164,.5)' : v < 0 ? '#ef4444' : '#22c55e');
      new Chart(ctx.getContext('2d'), { type: 'line', data: { labels, datasets: [{ label: '‰∫àÊÉ≥PER(ÂÄç)', data: values, borderColor: '#4a9eff', backgroundColor: 'rgba(74,158,255,.08)', fill: true, borderWidth: 2, pointRadius: 5, pointBackgroundColor: pointColors, pointBorderColor: '#fff', pointBorderWidth: 1.5, tension: .3, spanGaps: true }, { label: 'ÈªíÂ≠óËª¢Êèõ„É©„Ç§„É≥', data: labels.map(() => 0), borderColor: 'rgba(255,255,255,.15)', borderWidth: 1, borderDash: [4, 4], pointRadius: 0, fill: false }] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1a1d2e', borderColor: '#2d3252', borderWidth: 1, titleColor: '#94a3c8', bodyColor: '#e2e8f0', callbacks: { label: ctx => { if (ctx.datasetIndex === 1) return null; const v = ctx.parsed.y; return v == null ? '„Éá„Éº„Çø„Å™„Åó' : v < 0 ? `PER ${v}ÂÄçÔºàËµ§Â≠óÔºâ` : `PER ${v}ÂÄç`; } } } }, scales: { x: { ticks: { color: '#8892a4', maxTicksLimit: 8, maxRotation: 0 }, grid: { color: 'rgba(45,50,82,.5)' } }, y: { ticks: { color: '#8892a4', callback: v => v === 0 ? '0ÔºàÈªíÂ≠óËª¢ÊèõÔºâ' : `${v}ÂÄç` }, grid: { color: 'rgba(45,50,82,.5)' } } } } });
    }
  </script>
</body>

</html>