<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>éŠ˜æŸ„åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0f1117; --card: #1a1d2e; --card2: #22263a;
    --accent: #4a9eff; --accent2: #7c5cfc;
    --green: #22c55e; --red: #ef4444; --yellow: #f59e0b;
    --text: #e2e8f0; --muted: #8892a4; --border: #2d3252;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Hiragino Sans', 'Meiryo', sans-serif; font-size: 14px; line-height: 1.6; }
  .container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }

  /* æˆ»ã‚‹ãƒãƒ¼ */
  .back-bar { position: sticky; top: 0; z-index: 200; background: rgba(15,17,23,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #2d3252; padding: 8px 20px; display: flex; align-items: center; justify-content: space-between; }
  .back-btn { display: inline-flex; align-items: center; gap: 6px; color: #4a9eff; text-decoration: none; font-size: 13px; font-weight: 600; }
  .back-btn:hover { opacity: 0.8; }
  #backBarStatus { display: flex; align-items: center; gap: 8px; }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .header-card { background: linear-gradient(135deg, #1a1d2e 0%, #0f1a3a 100%); border: 1px solid var(--border); border-radius: 16px; padding: 28px; margin-bottom: 20px; }
  .header-top { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; }
  .company-info h1 { font-size: 28px; font-weight: 700; color: #fff; margin-bottom: 4px; }
  .company-meta { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
  .badge-blue   { background: rgba(74,158,255,0.15);  color: var(--accent);  border: 1px solid rgba(74,158,255,0.3); }
  .badge-purple { background: rgba(124,92,252,0.15);  color: #a78bfa;        border: 1px solid rgba(124,92,252,0.3); }
  .badge-gray   { background: rgba(136,146,164,0.15); color: var(--muted);   border: 1px solid rgba(136,146,164,0.3); }
  .badge-green  { background: rgba(34,197,94,0.15);   color: var(--green);   border: 1px solid rgba(34,197,94,0.3); }
  .badge-orange { background: rgba(245,158,11,0.15);  color: var(--yellow);  border: 1px solid rgba(245,158,11,0.3); }
  .badge-red    { background: rgba(239,68,68,0.15);   color: var(--red);     border: 1px solid rgba(239,68,68,0.3); }
  .catchcopy { margin-top: 14px; font-size: 16px; color: #94a3c8; font-style: italic; }
  .catchcopy span { color: var(--accent); font-weight: 600; }
  .data-badges { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }

  /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…±é€š */
  .section-title { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
  .section-title::before { content: ''; display: block; width: 4px; height: 20px; background: var(--accent); border-radius: 2px; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .section { margin-bottom: 24px; }

  /* ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ« */
  .biz-text p { margin-bottom: 12px; color: #cbd5e1; }
  .biz-text p:last-child { margin-bottom: 0; }
  .segment-card { background: var(--card2); border-radius: 10px; padding: 14px; margin-bottom: 10px; }
  .segment-card h4 { font-size: 13px; font-weight: 700; color: var(--accent); margin-bottom: 6px; }
  .segment-card p { font-size: 12px; color: var(--muted); line-height: 1.5; }
  .tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 12px; }

  /* KabuMartã‚¹ã‚³ã‚¢ */
  .score-section { display: grid; grid-template-columns: 220px 1fr; gap: 20px; align-items: center; }
  .score-circle-wrap { display: flex; flex-direction: column; align-items: center; }
  .score-circle { width: 140px; height: 140px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 12px; }
  .score-circle::after { content: ''; position: absolute; width: 110px; height: 110px; border-radius: 50%; background: var(--card); }
  .score-inner { position: relative; z-index: 1; text-align: center; }
  .score-val { font-size: 36px; font-weight: 800; color: #fff; line-height: 1; }
  .score-max { font-size: 14px; color: var(--muted); }
  .rank-badge-score { display: inline-block; padding: 4px 16px; border-radius: 20px; font-size: 18px; font-weight: 800; margin-top: 4px; }
  .axis-list { display: flex; flex-direction: column; gap: 10px; }
  .axis-item { display: flex; align-items: center; gap: 10px; }
  .axis-label { width: 80px; font-size: 12px; color: var(--muted); }
  .axis-bar-wrap { flex: 1; height: 8px; background: var(--card2); border-radius: 4px; overflow: hidden; }
  .axis-bar { height: 100%; border-radius: 4px; }
  .axis-val { width: 30px; font-size: 13px; font-weight: 700; color: #fff; text-align: right; }
  .axis-rank { width: 40px; }

  /* ã‚²ãƒ¼ã‚¸ */
  .gauge-wrap { display: flex; flex-direction: column; align-items: center; width: 100%; }
  .gauge-label { font-size: 13px; color: var(--muted); margin-bottom: 8px; text-align: center; width: 100%; }
  .gauge-svg { width: 120px; height: 70px; display: block; margin: 0 auto; }
  .gauge-val { font-size: 18px; font-weight: 800; color: #fff; text-align: center; margin-top: 4px; width: 100%; display: block; }
  .gauge-note { font-size: 11px; color: var(--muted); text-align: center; margin-top: 2px; width: 100%; display: block; }
  .gauge-tooltip { font-size: 11px; color: #94a3c8; text-align: center; margin-top: 6px; padding: 6px 8px; background: var(--card2); border-radius: 6px; line-height: 1.4; width: 100%; }

  /* ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ« */
  .val-table { width: 100%; border-collapse: collapse; }
  .val-table th { font-size: 11px; color: var(--muted); padding: 6px 8px; text-align: left; border-bottom: 1px solid var(--border); }
  .val-table td { font-size: 13px; padding: 7px 8px; border-bottom: 1px solid rgba(45,50,82,0.5); }
  .val-table tr:last-child td { border-bottom: none; }
  .val-good { color: var(--green); } .val-warn { color: var(--yellow); } .val-bad { color: var(--red); }

  /* ãƒã‚¸ãƒã‚¬ */
  .posi-nega { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .posi-card { background: rgba(34,197,94,0.06); border: 1px solid rgba(34,197,94,0.2); border-radius: 10px; padding: 14px; margin-bottom: 10px; }
  .nega-card { background: rgba(239,68,68,0.06); border: 1px solid rgba(239,68,68,0.2); border-radius: 10px; padding: 14px; margin-bottom: 10px; }
  .pn-title { font-size: 13px; font-weight: 700; margin-bottom: 6px; }
  .posi-card .pn-title { color: var(--green); } .nega-card .pn-title { color: var(--red); }
  .pn-explain { font-size: 12px; color: #94a3c8; line-height: 1.5; margin-top: 6px; padding: 6px 8px; background: rgba(255,255,255,0.03); border-radius: 6px; }
  .pn-source { font-size: 10px; color: var(--muted); margin-top: 6px; }
  .impact { display: inline-block; padding: 1px 7px; border-radius: 10px; font-size: 10px; font-weight: 700; margin-left: 6px; }
  .impact-high { background: rgba(239,68,68,0.2); color: #f87171; }
  .impact-mid  { background: rgba(245,158,11,0.2); color: #fbbf24; }
  .impact-low  { background: rgba(74,158,255,0.2); color: var(--accent); }

  /* ç·åˆè©•ä¾¡ */
  .verdict-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .verdict-item { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 10px; font-size: 13px; }
  .verdict-item .icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
  .summary-box { background: linear-gradient(135deg, rgba(74,158,255,0.1), rgba(124,92,252,0.1)); border: 1px solid rgba(74,158,255,0.3); border-radius: 12px; padding: 18px; }
  .summary-box h4 { color: var(--accent); font-size: 14px; font-weight: 700; margin-bottom: 10px; }
  .summary-box p { color: #cbd5e1; font-size: 13px; line-height: 1.7; }

  /* ãƒ•ãƒƒã‚¿ãƒ¼ */
  .footer { text-align: center; padding: 24px; color: var(--muted); font-size: 11px; border-top: 1px solid var(--border); margin-top: 32px; line-height: 1.8; }

  /* ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆãƒœã‚¿ãƒ³ */
  .watchlist-bar { position: sticky; bottom: 0; background: rgba(15,17,23,0.95); backdrop-filter: blur(10px); border-top: 1px solid var(--border); padding: 12px 20px; display: flex; justify-content: center; align-items: center; gap: 12px; z-index: 100; flex-wrap: wrap; }
  .watchlist-btn { background: linear-gradient(135deg, #4a9eff, #7c5cfc); color: #fff; border: none; border-radius: 10px; padding: 10px 28px; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
  .watchlist-btn:hover { opacity: 0.85; transform: translateY(-1px); }
  .watchlist-btn.copied { background: var(--green); }

  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ */
  .status-selector { position: relative; display: inline-flex; align-items: center; }
  .status-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; border: 1px solid; transition: all 0.2s; background: none; }
  .status-btn.st-watching   { color: var(--accent); border-color: rgba(74,158,255,0.4); background: rgba(74,158,255,0.1); }
  .status-btn.st-interested { color: var(--yellow); border-color: rgba(245,158,11,0.4); background: rgba(245,158,11,0.1); }
  .status-btn.st-pending    { color: var(--muted);  border-color: rgba(136,146,164,0.4); background: rgba(136,146,164,0.1); }
  .status-btn:hover { opacity: 0.8; }
  .status-dropdown { position: absolute; top: calc(100% + 8px); right: 0; background: #1a1d2e; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; min-width: 150px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); display: none; z-index: 300; }
  .status-dropdown.open { display: block; }
  .status-option { display: flex; align-items: center; gap: 8px; padding: 10px 14px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.15s; }
  .status-option:hover { background: rgba(255,255,255,0.06); }
  .status-option.active { background: rgba(74,158,255,0.1); }
  .status-saving { font-size: 11px; color: var(--muted); }
  .status-toast { font-size: 12px; padding: 6px 12px; border-radius: 8px; font-weight: 600; }
  .status-toast.ok  { background: rgba(34,197,94,0.15); color: var(--green); border: 1px solid rgba(34,197,94,0.3); }
  .status-toast.err { background: rgba(239,68,68,0.15); color: var(--red);   border: 1px solid rgba(239,68,68,0.3); }
  /* ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆback-barå†…ï¼‰ */
  .watchlist-del-btn { background: none; border: none; color: var(--muted); font-size: 15px; cursor: pointer; padding: 4px 6px; border-radius: 6px; opacity: 0.5; transition: opacity 0.15s, color 0.15s; line-height: 1; }
  .watchlist-del-btn:hover { opacity: 1; color: var(--red); }

  /* å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
  .del-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; align-items: center; justify-content: center; }
  .del-modal { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 28px 24px; max-width: 360px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
  .del-modal h3 { font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 10px; }
  .del-modal p { font-size: 13px; color: #94a3c8; line-height: 1.6; margin-bottom: 20px; }
  .del-modal-btns { display: flex; gap: 10px; justify-content: flex-end; }
  .del-btn-cancel { padding: 8px 18px; border-radius: 8px; border: 1px solid var(--border); background: none; color: var(--muted); font-size: 13px; cursor: pointer; }
  .del-btn-cancel:hover { background: rgba(255,255,255,0.05); }
  .del-btn-ok { padding: 8px 18px; border-radius: 8px; border: none; background: var(--red); color: #fff; font-size: 13px; font-weight: 700; cursor: pointer; }
  .del-btn-ok:hover { opacity: 0.85; }

  /* ãƒ¬ãƒãƒ¼ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ */
  .report-delete-bar { text-align: center; padding: 16px; margin-top: 8px; }
  .report-delete-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 20px; border-radius: 8px; border: 1px solid rgba(239,68,68,0.3); background: none; color: var(--red); font-size: 13px; cursor: pointer; transition: all 0.2s; opacity: 0.7; }
  .report-delete-btn:hover { opacity: 1; background: rgba(239,68,68,0.08); }

  /* PERæ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ */
  .per-chart-container { position: relative; height: 200px; }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° / ã‚¨ãƒ©ãƒ¼ */
  .loading { display: flex; align-items: center; justify-content: center; min-height: 60vh; flex-direction: column; gap: 16px; }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .error-box { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 12px; padding: 24px; text-align: center; max-width: 480px; margin: 60px auto; }
  .error-box h2 { color: var(--red); margin-bottom: 8px; }
  .error-box p { color: var(--muted); font-size: 13px; }

  /* ãƒãƒ£ãƒ¼ãƒˆ */
  .chart-container { position: relative; height: 240px; }
  .radar-container { position: relative; height: 280px; max-width: 320px; margin: 0 auto; }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
  @media (max-width: 768px) {
    .grid-2, .grid-3, .posi-nega, .verdict-grid, .score-section { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="back-bar">
  <a class="back-btn" href="../index.html">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
  <div id="backBarStatus"></div>
</div>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
<div id="loading" class="loading">
  <div class="spinner"></div>
  <div style="color:var(--muted);">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
</div>

<!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
<div id="error" style="display:none;">
  <div class="error-box">
    <h2>âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h2>
    <p id="errorMsg">éŠ˜æŸ„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
    <p style="margin-top:12px;"><a href="../index.html" style="color:var(--accent);">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a></p>
  </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆJS ã§ç”Ÿæˆï¼‰ -->
<div id="main" style="display:none;"></div>

<!-- ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆãƒœã‚¿ãƒ³ï¼ˆJS ã§è¡¨ç¤ºï¼‰ -->
<div id="watchlistBar" style="display:none;" class="watchlist-bar">
  <button class="watchlist-btn" id="watchBtn">ğŸ‘€ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã«è¿½åŠ </button>
</div>

<script>
// ============================================================
// ãƒ‡ãƒ¼ã‚¿å–å¾— & ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
// ============================================================
// é™çš„JSONï¼ˆåˆ†æãƒ‡ãƒ¼ã‚¿ï¼‰â†’ stok-analyzer ãƒªãƒã‚¸ãƒˆãƒªã® GitHub Raw ã‹ã‚‰å–å¾—ï¼ˆpushç›´å¾Œã«åæ˜ ï¼‰
const GITHUB_RAW = 'https://raw.githubusercontent.com/bi-al1/stok-analyzer/master';
const RENDER_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:8000'
  : 'https://stock-dashboard-rif1.onrender.com';

// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
const params = new URLSearchParams(location.search);
const code = params.get('code');

if (!code) {
  showError('URLã« ?code=XXXX ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚', '');
} else {
  document.title = `${code} åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰`;
  loadStock(code);
}

async function loadStock(code) {
  try {
    const ts = Date.now();
    // åˆ†æJSON ã¨ watchlist.json ã‚’ä¸¦è¡Œå–å¾—
    const [stockRes, wlRes] = await Promise.all([
      fetch(`${GITHUB_RAW}/webapp/data/stocks/${code.toUpperCase()}.json?_=${ts}`),
      fetch(`${RENDER_BASE}/api/watchlist`),  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ã§æœ€æ–°ã‚’å–å¾—
    ]);
    if (!stockRes.ok) throw new Error(`HTTP ${stockRes.status}`);
    const d = await stockRes.json();

    // watchlist ã‚¨ãƒ³ãƒˆãƒªã‚’å–å¾—ï¼ˆãªã‘ã‚Œã° nullï¼‰
    let wlEntry = null;
    if (wlRes.ok) {
      const wl = await wlRes.json();
      wlEntry = (wl.watchlist || []).find(w => w.code === code.toUpperCase()) ?? null;
    }

    render(d, wlEntry);
  } catch (e) {
    showError(`éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ "${code}" ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`, e.message);
  }
}

function showError(msg, detail) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error').style.display = 'block';
  document.getElementById('errorMsg').textContent = msg + (detail ? ` (${detail})` : '');
}

// ============================================================
// ãƒ©ãƒ³ã‚¯ã«å¿œã˜ãŸè‰²
// ============================================================
function rankColor(rank) {
  const map = { 'SSS':'#22c55e','SS':'#4ade80','S':'#86efac','A+':'#4a9eff','A':'#60a5fa','B+':'#a78bfa','B':'#c4b5fd','C':'#f59e0b','D':'#fb923c','E':'#ef4444','F':'#ef4444' };
  return map[rank] || '#8892a4';
}

function rankBadgeStyle(rank) {
  const c = rankColor(rank);
  return `display:inline-block;padding:4px 16px;border-radius:20px;font-size:18px;font-weight:800;background:${c}22;color:${c};border:1px solid ${c};margin-top:4px;`;
}

// KabuMartã‚¹ã‚³ã‚¢ï¼ˆ0ã€œ10ï¼‰ã‚’å††ã‚°ãƒ©ãƒ•ã®degreeã«å¤‰æ›
function scoreToDeg(score) {
  return Math.min((score / 10) * 360, 360);
}

// è»¸ã‚¹ã‚³ã‚¢ã®ãƒãƒ¼è‰²
function axisBarColor(rank) {
  if (['SSS','SS','S'].includes(rank)) return '#22c55e';
  if (['A+','A'].includes(rank)) return '#4a9eff';
  if (['B+','B'].includes(rank)) return '#a78bfa';
  if (['C'].includes(rank)) return '#f59e0b';
  return '#ef4444';
}

// ============================================================
// PER ã‚²ãƒ¼ã‚¸ SVG
// ============================================================
function perGaugeSVG(per) {
  if (per === null || per === undefined || per < 0) {
    return `<svg class="gauge-svg" viewBox="0 0 120 70">
      <path d="M10 60 A 50 50 0 0 1 110 60" stroke="#2d3252" stroke-width="10" fill="none" stroke-linecap="round"/>
      <path d="M10 60 A 50 50 0 0 1 110 60" stroke="#ef4444" stroke-width="10" fill="none" stroke-linecap="round" stroke-dasharray="157" stroke-dashoffset="0"/>
      <text x="60" y="52" text-anchor="middle" fill="#ef4444" font-size="10" font-weight="bold">èµ¤å­—</text>
    </svg>
    <div class="gauge-val" style="color:#ef4444;">${per !== null && per !== undefined ? per+'å€' : 'N/A'}</div>
    <div class="gauge-note">ï¼ˆèµ¤å­—ã®ãŸã‚è² å€¤ï¼‰</div>`;
  }
  // ç›®å®‰: 15å€ = 50%, 30å€ = 100%
  const ratio = Math.min(per / 30, 1);
  const offset = Math.round(157 * (1 - ratio));
  const color = per < 15 ? '#22c55e' : per < 25 ? '#f59e0b' : '#ef4444';
  return `<svg class="gauge-svg" viewBox="0 0 120 70">
    <path d="M10 60 A 50 50 0 0 1 110 60" stroke="#2d3252" stroke-width="10" fill="none" stroke-linecap="round"/>
    <path d="M10 60 A 50 50 0 0 1 110 60" stroke="${color}" stroke-width="10" fill="none" stroke-linecap="round" stroke-dasharray="157" stroke-dashoffset="${offset}"/>
  </svg>
  <div class="gauge-val" style="color:${color};">${per}å€</div>
  <div class="gauge-note">ç›®å®‰: 15ã€œ25å€</div>`;
}

function roeGaugeSVG(roe) {
  if (roe === null || roe === undefined || roe < 0) {
    return `<svg class="gauge-svg" viewBox="0 0 120 70">
      <path d="M10 60 A 50 50 0 0 1 110 60" stroke="#2d3252" stroke-width="10" fill="none" stroke-linecap="round"/>
      <path d="M10 60 A 50 50 0 0 1 110 60" stroke="#ef4444" stroke-width="10" fill="none" stroke-linecap="round" stroke-dasharray="157" stroke-dashoffset="0"/>
      <text x="60" y="52" text-anchor="middle" fill="#ef4444" font-size="10" font-weight="bold">èµ¤å­—</text>
    </svg>
    <div class="gauge-val" style="color:#ef4444;">${roe !== null && roe !== undefined ? roe.toFixed(1)+'%' : 'N/A'}</div>
    <div class="gauge-note">ç›®å®‰: 10%ä»¥ä¸ŠãŒå„ªè‰¯</div>`;
  }
  const ratio = Math.min(roe / 30, 1);
  const offset = Math.round(157 * (1 - ratio));
  const color = roe >= 10 ? '#22c55e' : roe >= 5 ? '#f59e0b' : '#ef4444';
  return `<svg class="gauge-svg" viewBox="0 0 120 70">
    <path d="M10 60 A 50 50 0 0 1 110 60" stroke="#2d3252" stroke-width="10" fill="none" stroke-linecap="round"/>
    <path d="M10 60 A 50 50 0 0 1 110 60" stroke="${color}" stroke-width="10" fill="none" stroke-linecap="round" stroke-dasharray="157" stroke-dashoffset="${offset}"/>
  </svg>
  <div class="gauge-val" style="color:${color};">${roe.toFixed(1)}%</div>
  <div class="gauge-note">ç›®å®‰: 10%ä»¥ä¸ŠãŒå„ªè‰¯</div>`;
}

function equityRatioGaugeSVG(ratio) {
  if (ratio === null || ratio === undefined) {
    return `<svg class="gauge-svg" viewBox="0 0 120 70">
      <path d="M10 60 A 50 50 0 0 1 110 60" stroke="#2d3252" stroke-width="10" fill="none" stroke-linecap="round"/>
    </svg>
    <div class="gauge-val">N/A</div>
    <div class="gauge-note">ç›®å®‰: 40%ä»¥ä¸ŠãŒå®‰å®š</div>`;
  }
  const r = Math.min(ratio / 100, 1);
  const offset = Math.round(157 * (1 - r));
  const color = ratio >= 40 ? '#22c55e' : ratio >= 20 ? '#f59e0b' : '#ef4444';
  return `<svg class="gauge-svg" viewBox="0 0 120 70">
    <path d="M10 60 A 50 50 0 0 1 110 60" stroke="#2d3252" stroke-width="10" fill="none" stroke-linecap="round"/>
    <path d="M10 60 A 50 50 0 0 1 110 60" stroke="${color}" stroke-width="10" fill="none" stroke-linecap="round" stroke-dasharray="157" stroke-dashoffset="${offset}"/>
  </svg>
  <div class="gauge-val" style="color:${color};">${ratio.toFixed(1)}%</div>
  <div class="gauge-note">ç›®å®‰: 40%ä»¥ä¸ŠãŒå®‰å®š</div>`;
}

// ============================================================
// ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
// ============================================================
function render(d, wlEntry) {
  const c = d.company;
  const scores = d.scores;
  const fin = d.financials;
  const price = d.price;
  const biz = d.business;
  const verdict = d.verdict;
  const positives = d.positives || [];
  const negatives = d.negatives || [];
  const priceHistory = d.price_history || [];

  // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
  document.title = `${c.name}ï¼ˆ${c.code}ï¼‰åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰`;

  // ã‚¹ã‚³ã‚¢ã®å††ã‚°ãƒ©ãƒ•è‰²
  const scoreColor = rankColor(scores.total_rank);
  const scoreDeg = scoreToDeg(scores.total_score);
  const scoreConicBg = `conic-gradient(${scoreColor} 0deg ${scoreDeg}deg, #2d3252 ${scoreDeg}deg 360deg)`;

  // ãƒã‚¸ãƒã‚¬ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
  function posiCards(items) {
    return items.map(item => `
      <div class="posi-card">
        <div class="pn-title">${item.title} <span class="impact impact-${(item.impact||'mid').toLowerCase()}">${(item.impact||'MID').toUpperCase()}</span></div>
        <div class="pn-explain">ğŸ’¬ <strong>ã¤ã¾ã‚Šï¼Ÿ</strong> ${item.explain || ''}</div>
        <div class="pn-source">${item.source || ''}</div>
      </div>`).join('');
  }
  function negaCards(items) {
    return items.map(item => `
      <div class="nega-card">
        <div class="pn-title">${item.title} <span class="impact impact-${(item.impact||'mid').toLowerCase()}">${(item.impact||'MID').toUpperCase()}</span></div>
        <div class="pn-explain">ğŸ’¬ <strong>ã¤ã¾ã‚Šï¼Ÿ</strong> ${item.explain || ''}</div>
        <div class="pn-source">${item.source || ''}</div>
      </div>`).join('');
  }

  // è»¸ãƒãƒ¼ç”Ÿæˆ
  const axisKeys = [
    { key: 'growth',      label: 'æˆé•·æ€§' },
    { key: 'stability',   label: 'å®‰å®šæ€§' },
    { key: 'profitability', label: 'åç›Šæ€§' },
    { key: 'capacity',    label: 'ä½™åŠ›' },
    { key: 'innovation',  label: 'æ–°è¦æ€§' },
  ];
  const axisBars = axisKeys.map(ax => {
    const val  = scores.axes?.[ax.key]?.score ?? 0;
    const rank = scores.axes?.[ax.key]?.rank  ?? 'F';
    const pct  = (val / 10 * 100).toFixed(0);
    const color = axisBarColor(rank);
    return `<div class="axis-item">
      <span class="axis-label">${ax.label}</span>
      <div class="axis-bar-wrap"><div class="axis-bar" style="width:${pct}%;background:${color};"></div></div>
      <span class="axis-val">${val.toFixed(1)}</span>
      <span class="axis-rank"><span class="badge badge-gray" style="font-size:10px;">${rank}</span></span>
    </div>`;
  }).join('');

  // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰
  const segCards = (biz.segments || []).map(s => `
    <div class="segment-card" style="${s.highlight ? 'background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.2);' : ''}">
      <h4 style="${s.highlight ? 'color:var(--green);' : ''}">${s.icon || ''} ${s.name}</h4>
      <p>${s.description || ''}</p>
    </div>`).join('');

  // ã‚¿ã‚°ãƒãƒƒã‚¸
  const tagBadges = (biz.tags || []).map(t => `<span class="badge badge-blue">${t}</span>`).join('');

  // ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è¡Œ
  const valRows = (fin.valuation_table || []).map(row => {
    const cls = row.status === 'good' ? 'val-good' : row.status === 'warn' ? 'val-warn' : row.status === 'bad' ? 'val-bad' : '';
    const badgeHtml = row.badge ? `<span class="badge badge-${row.badge_color||'gray'}">${row.badge}</span>` : 'â€•';
    return `<tr>
      <td>${row.label}</td>
      <td class="${cls}">${row.value}</td>
      <td>${row.benchmark || 'â€•'}</td>
      <td>${badgeHtml}</td>
      <td style="font-size:11px;color:var(--muted);">${row.note || ''}</td>
    </tr>`;
  }).join('');

  // å¼·ã¿ãƒ»æ‡¸å¿µ
  const strengthItems = (verdict.strengths || []).map(s => `
    <div class="verdict-item"><span class="icon">${s.icon||'ğŸ’ª'}</span><span><strong>${s.title}</strong>ï¼š${s.text}</span></div>`).join('');
  const riskItems = (verdict.risks || []).map(r => `
    <div class="verdict-item"><span class="icon">${r.icon||'âš ï¸'}</span><span><strong>${r.title}</strong>ï¼š${r.text}</span></div>`).join('');

  // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒãƒƒã‚¸
  const sourceBadges = [
    d.has_yfinance  ? '<span class="badge badge-green">ğŸ“Š yfinanceå–å¾—æ¸ˆ</span>' : '',
    d.has_websearch ? '<span class="badge badge-blue">ğŸ” WebSearchèª¿æŸ»æ¸ˆ</span>' : '',
    d.has_kabumart  ? '<span class="badge badge-purple">ğŸ“Œ KabuMartã‚¹ã‚³ã‚¢åæ˜ </span>' : '',
  ].filter(Boolean).join('');

  // ãƒªãƒ³ã‚¯
  const links = (d.links || []).map(l => `<a href="${l.url}" target="_blank" style="color:var(--accent);">${l.label}</a>`).join(' / ');

  const html = `
<div class="container">

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div class="header-card">
  <div class="header-top">
    <div class="company-info">
      <h1>${c.name}</h1>
      <div class="company-meta">
        <span class="badge badge-blue">${c.code}</span>
        <span class="badge badge-purple">${c.industry || ''}</span>
        <span class="badge badge-gray">${c.market || ''}</span>
        ${c.extra_badge ? `<span class="badge badge-orange">${c.extra_badge}</span>` : ''}
      </div>
    </div>
    <div style="text-align:right;">
      <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">èª¿æŸ»æ—¥</div>
      <div style="font-size:16px;font-weight:700;color:#fff;">${c.analyzed_date || ''}</div>
      ${price.current ? `<div style="font-size:13px;color:var(--accent);margin-top:4px;">ç¾åœ¨æ ªä¾¡ Â¥${price.current.toLocaleString()}</div>` : ''}
    </div>
  </div>
  <div class="catchcopy">
    ${biz.catchcopy || ''}
  </div>
  <div class="data-badges">${sourceBadges}</div>
</div>

<!-- ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ« -->
<div class="section">
  <div class="section-title">ã“ã®ä¼šç¤¾ã¯ä½•ã‚’ã—ã¦ã„ã‚‹ï¼Ÿ</div>
  <div class="grid-2">
    <div class="card biz-text">
      ${(biz.paragraphs || []).map(p => `<p>${p}</p>`).join('')}
      <div class="tags">${tagBadges}</div>
    </div>
    <div>${segCards}</div>
  </div>
</div>

<!-- KabuMartã‚¹ã‚³ã‚¢ -->
<div class="section">
  <div class="section-title">KabuMartã‚¹ã‚³ã‚¢</div>
  <div class="card">
    <div class="score-section">
      <div class="score-circle-wrap">
        <div class="score-circle" style="background:${scoreConicBg};">
          <div class="score-inner">
            <div class="score-val">${scores.total_score}</div>
            <div class="score-max">/10</div>
          </div>
        </div>
        <div class="rank-badge-score" style="${rankBadgeStyle(scores.total_rank)}">${scores.total_rank} ãƒ©ãƒ³ã‚¯</div>
        ${scores.note ? `<div style="font-size:12px;color:var(--muted);margin-top:8px;text-align:center;">${scores.note}</div>` : ''}
      </div>
      <div>
        <div class="radar-container">
          <canvas id="radarChart"></canvas>
        </div>
        <div class="axis-list" style="margin-top:16px;">${axisBars}</div>
        ${scores.interpretation ? `<div style="margin-top:14px;padding:12px;background:var(--card2);border-radius:8px;font-size:12px;color:#94a3c8;line-height:1.6;">ğŸ’¡ <strong style="color:var(--yellow);">ã‚¹ã‚³ã‚¢ã®èª­ã¿æ–¹ï¼š</strong>${scores.interpretation}</div>` : ''}
      </div>
    </div>
  </div>
</div>

<!-- ä¸»è¦è²¡å‹™æŒ‡æ¨™ -->
<div class="section">
  <div class="section-title">ä¸»è¦è²¡å‹™æŒ‡æ¨™</div>
  <div class="grid-3" style="margin-bottom:16px;">
    <div class="card">
      <div class="gauge-label">äºˆæƒ³PERï¼ˆæ ªä¾¡åç›Šç‡ï¼‰</div>
      ${perGaugeSVG(fin.per)}
      <div class="gauge-tooltip">${fin.per_note || 'PERã¯ã€Œæ ªä¾¡Ã·1æ ªåˆ©ç›Šã€ã§ã€ä¼æ¥­ã®åˆ©ç›Šã«å¯¾ã—ã¦æ ªä¾¡ãŒä½•å€ã‹ã‚’ç¤ºã™æŒ‡æ¨™ã€‚'}</div>
    </div>
    <div class="card">
      <div class="gauge-label">ROEï¼ˆè‡ªå·±è³‡æœ¬åˆ©ç›Šç‡ï¼‰</div>
      ${roeGaugeSVG(fin.roe)}
      <div class="gauge-tooltip">${fin.roe_note || 'ROEã¯ã€Œæ ªä¸»ã®ãŠé‡‘ã‚’ä½¿ã£ã¦ã©ã‚Œã ã‘åˆ©ç›Šã‚’å‡ºã›ãŸã‹ã€ã®æŒ‡æ¨™ã€‚'}</div>
    </div>
    <div class="card">
      <div class="gauge-label">è‡ªå·±è³‡æœ¬æ¯”ç‡</div>
      ${equityRatioGaugeSVG(fin.equity_ratio)}
      <div class="gauge-tooltip">${fin.equity_ratio_note || 'ä¼šç¤¾ã®è³‡ç”£ã®ã†ã¡ã€å€Ÿé‡‘ã§ãªã„è‡ªå·±è³‡é‡‘ã®å‰²åˆã€‚40%ä»¥ä¸ŠãŒå®‰å®šã®ç›®å®‰ã€‚'}</div>
    </div>
  </div>
  ${valRows ? `
  <div class="card">
    <div style="font-size:14px;font-weight:700;color:#fff;margin-bottom:12px;">ğŸ“Š ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è©³ç´°ï¼ˆyfinanceå–å¾—å€¤ï¼‰</div>
    <table class="val-table">
      <thead><tr><th>æŒ‡æ¨™</th><th>å€¤</th><th>ç›®å®‰</th><th>è©•ä¾¡</th><th>ã¤ã¾ã‚Šï¼Ÿ</th></tr></thead>
      <tbody>${valRows}</tbody>
    </table>
  </div>` : ''}
</div>

<!-- PERæ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆç™»éŒ²æ¸ˆã¿ã‹ã¤å±¥æ­´1ä»¶ä»¥ä¸Šã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
${wlEntry && wlEntry.per_history && wlEntry.per_history.length >= 1 ? `
<div class="section" id="perHistorySection">
  <div class="section-title">äºˆæƒ³PER æ¨ç§»</div>
  <div class="card">
    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px;font-size:12px;color:var(--muted);">
      <span>ğŸ“Š ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®ãŸã³ã«æ›´æ–°ã•ã‚Œã¾ã™</span>
      <span>èµ¤å­—æœŸé–“ã¯ãƒã‚¤ãƒŠã‚¹å€¤ï¼ˆçµ¶å¯¾å€¤ãŒå°ã•ã„ã»ã©èµ¤å­—ç¸®å°ï¼‰</span>
    </div>
    <div class="per-chart-container"><canvas id="perChart"></canvas></div>
  </div>
</div>` : ''}

<!-- æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆ -->
${priceHistory.length > 0 ? `
<div class="section">
  <div class="section-title">æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆï¼ˆéå»1å¹´é–“ï¼‰</div>
  <div class="card">
    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px;font-size:13px;">
      ${price.current ? `<span>ç¾åœ¨: <strong style="color:var(--accent);">Â¥${price.current.toLocaleString()}</strong></span>` : ''}
      ${price.week52_high ? `<span>52é€±é«˜å€¤: <strong style="color:var(--green);">Â¥${price.week52_high.toLocaleString()}</strong></span>` : ''}
      ${price.week52_low  ? `<span>52é€±å®‰å€¤: <strong style="color:var(--red);">Â¥${price.week52_low.toLocaleString()}</strong></span>` : ''}
      ${price.from_high_pct ? `<span style="color:var(--muted);">é«˜å€¤æ¯”: ${price.from_high_pct}</span>` : ''}
    </div>
    <div class="chart-container"><canvas id="priceChart"></canvas></div>
    <div style="margin-top:10px;font-size:11px;color:var(--muted);">â€» yfinanceå–å¾—å€¤ï¼ˆé…å»¶ãƒ‡ãƒ¼ã‚¿ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰</div>
  </div>
</div>` : ''}

<!-- ãƒã‚¸ãƒã‚¬ -->
<div class="section">
  <div class="section-title">ãƒã‚¸ãƒ†ã‚£ãƒ– / ãƒã‚¬ãƒ†ã‚£ãƒ–è¦å› </div>
  <div class="posi-nega">
    <div>
      <div style="font-size:14px;font-weight:700;color:var(--green);margin-bottom:12px;">âœ… ãƒã‚¸ãƒ†ã‚£ãƒ–è¦ç´ </div>
      ${posiCards(positives)}
    </div>
    <div>
      <div style="font-size:14px;font-weight:700;color:var(--red);margin-bottom:12px;">âš ï¸ ãƒã‚¬ãƒ†ã‚£ãƒ–è¦ç´ </div>
      ${negaCards(negatives)}
    </div>
  </div>
</div>

<!-- ç·åˆè©•ä¾¡ -->
<div class="section">
  <div class="section-title">ç·åˆè©•ä¾¡</div>
  <div class="verdict-grid">
    <div class="card">
      <div style="font-size:13px;font-weight:700;color:var(--green);margin-bottom:12px;">ğŸ’ª ã“ã®ä¼šç¤¾ã®å¼·ã¿</div>
      ${strengthItems}
    </div>
    <div class="card">
      <div style="font-size:13px;font-weight:700;color:var(--red);margin-bottom:12px;">âš ï¸ æ°—ã‚’ã¤ã‘ãŸã„ãƒªã‚¹ã‚¯</div>
      ${riskItems}
    </div>
  </div>
  <div class="summary-box">
    <h4>ğŸ“ ãµã‚†ã•ã‚“ã¸ï¼šåˆå¿ƒè€…å‘ã‘ã¾ã¨ã‚</h4>
    <p>${verdict.summary || ''}</p>
  </div>
</div>

<!-- ãƒ¬ãƒãƒ¼ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ -->
<div class="report-delete-bar">
  <button class="report-delete-btn" id="reportDeleteBtn" onclick="showDeleteReportModal('${c.code}', '${c.name}')">
    ğŸ—‘ï¸ åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’å‰Šé™¤
  </button>
</div>

<!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
<div class="footer">
  <p>âš ï¸ ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯æŠ•è³‡åŠ©è¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ²è¼‰æƒ…å ±ã¯å…¬é–‹æƒ…å ±ã«åŸºã¥ãåˆ†æã§ã‚ã‚Šã€æ­£ç¢ºæ€§ãƒ»å®Œå…¨æ€§ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  <p>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼šKabuMartï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè§£æï¼‰ã€yfinanceï¼ˆé…å»¶ãƒ‡ãƒ¼ã‚¿ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰ã€WebSearchï¼ˆå„ç¨®å…¬é–‹æƒ…å ±ï¼‰</p>
  ${links ? `<p>å‚è€ƒï¼š${links}</p>` : ''}
  <p style="margin-top:8px;">ç”Ÿæˆæ—¥æ™‚: ${d.generated_at || c.analyzed_date} | Powered by Claude + KabuMart Analyzer</p>
</div>

</div><!-- /container -->
`;

  document.getElementById('main').innerHTML = html;
  document.getElementById('loading').style.display = 'none';
  document.getElementById('main').style.display = 'block';

  // â”€â”€ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆãƒãƒ¼ï¼ˆè¿½åŠ ãƒœã‚¿ãƒ³ï¼‰/ back-barã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const watchBar = document.getElementById('watchlistBar');

  // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³ / ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
  if (wlEntry) {
    // ç™»éŒ²æ¸ˆã¿ â†’ watchlistBaréè¡¨ç¤ºã€back-barã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼è¡¨ç¤º
    watchBar.style.display = 'none';
    renderStatusSelector(wlEntry, c.code);
  } else {
    // æœªç™»éŒ² â†’ è¿½åŠ ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆAPIã§ç›´æ¥ç™»éŒ²ï¼‰
    watchBar.style.display = 'flex';
    document.getElementById('watchBtn').onclick = async () => {
      const btn = document.getElementById('watchBtn');
      btn.textContent = 'â³ è¿½åŠ ä¸­...';
      btn.disabled = true;
      try {
        const res = await fetch(`${RENDER_BASE}/api/watchlist`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: c.code,
            name: c.name,
            note: `KabuMartã‚¹ã‚³ã‚¢${c.kabumart_rank}(${c.kabumart_score})`,
            kabumart_rank: c.kabumart_rank ?? '',
          }),
        });
        const json = await res.json();
        if (res.status === 409) {
          // ã™ã§ã«ç™»éŒ²æ¸ˆã¿ï¼ˆç«¶åˆï¼‰
          btn.textContent = 'âœ… ç™»éŒ²æ¸ˆã¿';
          setTimeout(() => {
            watchBar.style.display = 'none';
            renderStatusSelector({ status: 'watching' }, c.code);
          }, 1000);
        } else if (!res.ok) {
          throw new Error(json.detail ?? 'ã‚¨ãƒ©ãƒ¼');
        } else {
          btn.textContent = 'âœ… ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ';
          btn.classList.add('copied');
          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆï¼ˆbottom baréè¡¨ç¤º â†’ back-barã«è¡¨ç¤ºï¼‰
          setTimeout(() => {
            watchBar.style.display = 'none';
            renderStatusSelector({ status: 'watching' }, c.code);
          }, 1000);
        }
      } catch(e) {
        btn.textContent = `âš ï¸ å¤±æ•—: ${e.message}`;
        btn.disabled = false;
        setTimeout(() => {
          btn.textContent = 'ğŸ‘€ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã«è¿½åŠ ';
          btn.disabled = false;
        }, 2500);
      }
    };
  }

  // ãƒãƒ£ãƒ¼ãƒˆæç”»ï¼ˆDOM ç”Ÿæˆå¾Œï¼‰
  requestAnimationFrame(() => {
    drawRadar(scores);
    if (priceHistory.length > 0) drawPrice(priceHistory, d.ipo_date);
    if (wlEntry?.per_history?.length >= 1) drawPerHistory(wlEntry.per_history);
  });
}

// ============================================================
// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
// ============================================================
const STATUS_MAP = {
  interested: { label: 'ğŸ’› ç©æ¥µæ¤œè¨', cls: 'st-interested' },
  watching:   { label: 'ğŸ‘€ è¦è¦³å¯Ÿ',   cls: 'st-watching'   },
  pending:    { label: 'â³ è¦‹é€ã‚Šä¸­', cls: 'st-pending'    },
};

function renderStatusSelector(wlEntry, code) {
  const container = document.getElementById('backBarStatus');
  let currentStatus = wlEntry.status || 'watching';

  // æ—¢å­˜ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ãŒã‚ã‚Œã°å†åˆ©ç”¨ï¼ˆè¿½åŠ å¾Œã®åˆ‡ã‚Šæ›¿ãˆæ™‚ï¼‰
  let sel = document.getElementById('statusSelector');
  let toastEl = document.getElementById('statusToast');
  let delBtn = document.getElementById('watchlistDelBtn');

  if (!sel) {
    sel = document.createElement('div');
    sel.className = 'status-selector';
    sel.id = 'statusSelector';
    container.appendChild(sel);
  }
  if (!toastEl) {
    toastEl = document.createElement('span');
    toastEl.className = 'status-toast';
    toastEl.id = 'statusToast';
    toastEl.style.display = 'none';
    container.appendChild(toastEl);
  }
  if (!delBtn) {
    delBtn = document.createElement('button');
    delBtn.className = 'watchlist-del-btn';
    delBtn.id = 'watchlistDelBtn';
    delBtn.title = 'ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤';
    delBtn.textContent = 'ğŸ—‘ï¸';
    delBtn.onclick = () => showDeleteWatchlistModal(code);
    container.appendChild(delBtn);
  }

  sel.innerHTML = buildSelectorHTML(currentStatus);

  // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³é–‹é–‰ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ãƒ»ä¸€åº¦ã ã‘ç™»éŒ²ï¼‰
  sel.onclick = e => {
    const btn = e.target.closest('.status-btn');
    const opt = e.target.closest('.status-option');
    if (btn) {
      sel.querySelector('.status-dropdown').classList.toggle('open');
      return;
    }
    if (opt) {
      sel.querySelector('.status-dropdown').classList.remove('open');
      const newStatus = opt.dataset.status;
      if (newStatus === currentStatus) return;
      currentStatus = newStatus;
      updateStatus(code, newStatus, sel, toastEl);
    }
  };

  // å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼ˆä¸€åº¦ã ã‘ç™»éŒ²ï¼‰
  if (!sel._outsideClickBound) {
    sel._outsideClickBound = true;
    document.addEventListener('click', e => {
      if (!sel.contains(e.target)) {
        sel.querySelector('.status-dropdown')?.classList.remove('open');
      }
    });
  }
}

function buildSelectorHTML(current) {
  const cur = STATUS_MAP[current] || STATUS_MAP.watching;
  const options = Object.entries(STATUS_MAP).map(([val, info]) => `
    <div class="status-option${val === current ? ' active' : ''}" data-status="${val}">
      ${info.label}
    </div>`).join('');
  return `
    <button class="status-btn ${cur.cls}">${cur.label} â–¾</button>
    <div class="status-dropdown">${options}</div>`;
}

async function updateStatus(code, newStatus, selEl, toastEl) {
  selEl.querySelector('.status-dropdown').classList.remove('open');
  toastEl.className = 'status-toast status-saving';
  toastEl.textContent = 'æ›´æ–°ä¸­...';
  toastEl.style.display = '';

  try {
    const res = await fetch(`${RENDER_BASE}/api/watchlist/status`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, status: newStatus }),
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.detail ?? json.error);

    // UIæ›´æ–°ï¼ˆonclick ã¯ sel.onclick ã§ç®¡ç†ã—ã¦ã„ã‚‹ã®ã§å†ãƒã‚¤ãƒ³ãƒ‰ä¸è¦ï¼‰
    selEl.innerHTML = buildSelectorHTML(newStatus);
    toastEl.style.display = 'none';

  } catch(e) {
    toastEl.className = 'status-toast err';
    toastEl.textContent = `âš ï¸ æ›´æ–°å¤±æ•—: ${e.message}`;
    setTimeout(() => { toastEl.style.display = 'none'; }, 3000);
  }
}

// ============================================================
// å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«
// ============================================================
function showModal({ title, body, okLabel, onOk }) {
  const overlay = document.createElement('div');
  overlay.className = 'del-modal-overlay';
  overlay.innerHTML = `
    <div class="del-modal">
      <h3>${title}</h3>
      <p>${body}</p>
      <div class="del-modal-btns">
        <button class="del-btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="del-btn-ok">${okLabel}</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  overlay.querySelector('.del-btn-cancel').onclick = () => overlay.remove();
  overlay.querySelector('.del-btn-ok').onclick = () => { overlay.remove(); onOk(); };
}

async function showDeleteWatchlistModal(code) {
  showModal({
    title: 'ğŸ—‘ï¸ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤',
    body: 'ã“ã®éŠ˜æŸ„ã‚’ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚<br>åˆ†æãƒ¬ãƒãƒ¼ãƒˆã¯æ®‹ã‚Šã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
    okLabel: 'å‰Šé™¤ã™ã‚‹',
    onOk: async () => {
      const toastEl = document.getElementById('statusToast');
      toastEl.className = 'status-toast status-saving';
      toastEl.textContent = 'å‰Šé™¤ä¸­...';
      toastEl.style.display = '';
      try {
        const res = await fetch(`${RENDER_BASE}/api/watchlist/${code}`, { method: 'DELETE' });
        const json = await res.json();
        if (!json.ok) throw new Error(json.detail ?? 'ã‚¨ãƒ©ãƒ¼');
        // back-barã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
        document.getElementById('backBarStatus').innerHTML = '';
        toastEl.style.display = 'none';
      } catch(e) {
        toastEl.className = 'status-toast err';
        toastEl.textContent = `âš ï¸ å‰Šé™¤å¤±æ•—: ${e.message}`;
        setTimeout(() => { toastEl.style.display = 'none'; }, 3000);
      }
    }
  });
}

async function showDeleteReportModal(code, name) {
  showModal({
    title: 'ğŸ—‘ï¸ åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’å‰Šé™¤',
    body: `<strong>${name}</strong> ã®åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`,
    okLabel: 'å‰Šé™¤ã™ã‚‹',
    onOk: async () => {
      const btn = document.getElementById('reportDeleteBtn');
      if (btn) { btn.disabled = true; btn.textContent = 'å‰Šé™¤ä¸­...'; }
      try {
        const res = await fetch(`${RENDER_BASE}/api/report/${code}`, { method: 'DELETE' });
        const json = await res.json();
        if (!json.ok) throw new Error(json.detail ?? 'ã‚¨ãƒ©ãƒ¼');
        window.location.href = '../index.html';
      } catch(e) {
        if (btn) { btn.disabled = false; btn.innerHTML = 'ğŸ—‘ï¸ åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’å‰Šé™¤'; }
        alert(`å‰Šé™¤å¤±æ•—: ${e.message}`);
      }
    }
  });
}

// ============================================================
// ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
// ============================================================
function drawRadar(scores) {
  const ctx = document.getElementById('radarChart');
  if (!ctx) return;
  const axes = scores.axes || {};
  const vals = [
    axes.growth?.score       ?? 0,
    axes.stability?.score    ?? 0,
    axes.profitability?.score?? 0,
    axes.capacity?.score     ?? 0,
    axes.innovation?.score   ?? 0,
  ];
  const ranks = [
    axes.growth?.rank       ?? 'F',
    axes.stability?.rank    ?? 'F',
    axes.profitability?.rank?? 'F',
    axes.capacity?.rank     ?? 'F',
    axes.innovation?.rank   ?? 'F',
  ];
  const labels = [
    `æˆé•·æ€§\n(${vals[0]}/${ranks[0]})`,
    `å®‰å®šæ€§\n(${vals[1]}/${ranks[1]})`,
    `åç›Šæ€§\n(${vals[2]}/${ranks[2]})`,
    `ä½™åŠ›\n(${vals[3]}/${ranks[3]})`,
    `æ–°è¦æ€§\n(${vals[4]}/${ranks[4]})`,
  ];
  new Chart(ctx.getContext('2d'), {
    type: 'radar',
    data: {
      labels,
      datasets: [{
        label: 'ã‚¹ã‚³ã‚¢', data: vals,
        backgroundColor: 'rgba(74,158,255,0.15)', borderColor: '#4a9eff',
        pointBackgroundColor: '#4a9eff', pointBorderColor: '#fff', pointRadius: 4, borderWidth: 2,
      }, {
        label: 'å¹³å‡åŸºæº–(5.0)', data: [5,5,5,5,5],
        backgroundColor: 'transparent', borderColor: 'rgba(255,255,255,0.2)',
        pointRadius: 0, borderWidth: 1, borderDash: [4,4],
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: true,
      plugins: { legend: { display: false } },
      scales: { r: {
        min: 0, max: 10, ticks: { display: false },
        grid: { color: 'rgba(255,255,255,0.1)' },
        angleLines: { color: 'rgba(255,255,255,0.1)' },
        pointLabels: { color: '#94a3c8', font: { size: 10 } }
      }}
    }
  });
}

// ============================================================
// PERæ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ
// ============================================================
function drawPerHistory(perHistory) {
  const ctx = document.getElementById('perChart');
  if (!ctx) return;

  const labels = perHistory.map(h => h.date);
  const values = perHistory.map(h => h.per);

  // 0ãƒ©ã‚¤ãƒ³ã¨ã‚¾ãƒ¼ãƒ³è‰²ï¼šãƒã‚¤ãƒŠã‚¹=èµ¤å­—æœŸé–“ã€ãƒ—ãƒ©ã‚¹=é»’å­—æœŸé–“
  const pointColors = values.map(v =>
    v == null ? 'rgba(136,146,164,0.5)' :
    v < 0     ? '#ef4444' : '#22c55e'
  );

  new Chart(ctx.getContext('2d'), {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'äºˆæƒ³PERï¼ˆå€ï¼‰',
        data: values,
        borderColor: '#4a9eff',
        backgroundColor: 'rgba(74,158,255,0.08)',
        fill: true,
        borderWidth: 2,
        pointRadius: 5,
        pointBackgroundColor: pointColors,
        pointBorderColor: '#fff',
        pointBorderWidth: 1.5,
        tension: 0.3,
        spanGaps: true,
      }, {
        // 0ãƒ©ã‚¤ãƒ³ï¼ˆé»’å­—/èµ¤å­—ã®å¢ƒç•Œï¼‰
        label: 'é»’å­—è»¢æ›ãƒ©ã‚¤ãƒ³',
        data: labels.map(() => 0),
        borderColor: 'rgba(255,255,255,0.15)',
        borderWidth: 1,
        borderDash: [4, 4],
        pointRadius: 0,
        fill: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1d2e',
          borderColor: '#2d3252',
          borderWidth: 1,
          titleColor: '#94a3c8',
          bodyColor: '#e2e8f0',
          callbacks: {
            title: ctx => ctx[0].label,
            label: ctx => {
              if (ctx.datasetIndex === 1) return null;
              const v = ctx.parsed.y;
              if (v == null) return 'ãƒ‡ãƒ¼ã‚¿ãªã—';
              return v < 0
                ? `PER ${v}å€ï¼ˆèµ¤å­—ï¼‰`
                : `PER ${v}å€`;
            },
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#8892a4', maxTicksLimit: 8, maxRotation: 0 },
          grid: { color: 'rgba(45,50,82,0.5)' }
        },
        y: {
          ticks: {
            color: '#8892a4',
            callback: v => v === 0 ? '0ï¼ˆé»’å­—è»¢æ›ï¼‰' : `${v}å€`
          },
          grid: { color: 'rgba(45,50,82,0.5)' }
        }
      }
    }
  });
}

// ============================================================
// æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆ
// ============================================================
function drawPrice(priceHistory, ipoDate) {
  const ctx = document.getElementById('priceChart');
  if (!ctx) return;
  const labels = priceHistory.map(d => d.date);
  const closes = priceHistory.map(d => d.close);
  const ipoIdx = ipoDate ? labels.indexOf(ipoDate) : -1;
  new Chart(ctx.getContext('2d'), {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'çµ‚å€¤ (å††)', data: closes,
        borderColor: '#4a9eff', backgroundColor: 'rgba(74,158,255,0.08)',
        fill: true, borderWidth: 2, pointRadius: 0, pointHoverRadius: 5, tension: 0.3,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1d2e', borderColor: '#2d3252', borderWidth: 1,
          titleColor: '#94a3c8', bodyColor: '#e2e8f0',
          callbacks: { title: ctx => ctx[0].label, label: ctx => `Â¥${ctx.parsed.y.toLocaleString()}` }
        },
        annotation: ipoIdx > 0 ? { annotations: { line1: {
          type: 'line', xMin: ipoIdx, xMax: ipoIdx,
          borderColor: 'rgba(245,158,11,0.6)', borderWidth: 1, borderDash: [4,4],
          label: { content: 'ä¸Šå ´', enabled: true, color: '#f59e0b', backgroundColor: 'transparent', font: { size: 10 } }
        }}} : {}
      },
      scales: {
        x: { ticks: { color: '#8892a4', maxTicksLimit: 8, maxRotation: 0,
          callback: (v, i) => { const d = labels[i]; return d ? d.slice(2,7).replace('-','/') : ''; }
        }, grid: { color: 'rgba(45,50,82,0.5)' }},
        y: { ticks: { color: '#8892a4', callback: v => 'Â¥'+v.toLocaleString() }, grid: { color: 'rgba(45,50,82,0.5)' }}
      }
    }
  });
}
</script>
</body>
</html>
