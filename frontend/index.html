<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <title>æŠ•è³‡ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <style>
    :root {
      --bg: #0f1117;
      --card: #1a1d2e;
      --card2: #22263a;
      --accent: #4a9eff;
      --accent2: #7c5cfc;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #f59e0b;
      --text: #e2e8f0;
      --muted: #8892a4;
      --border: #2d3252
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    html,
    body {
      height: 100%;
      overflow: hidden
    }

    /* Custom scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(136, 146, 164, .25) transparent
    }

    *::-webkit-scrollbar {
      width: 6px;
      height: 6px
    }

    *::-webkit-scrollbar-track {
      background: transparent
    }

    *::-webkit-scrollbar-thumb {
      background: rgba(136, 146, 164, .25);
      border-radius: 3px
    }

    *::-webkit-scrollbar-thumb:hover {
      background: rgba(136, 146, 164, .45)
    }

    *::-webkit-scrollbar-corner {
      background: transparent
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
      font-size: 17px;
      line-height: 1.7
    }

    /* Shell */
    .shell {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 12px 16px
    }

    .shell-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      flex-shrink: 0
    }

    .shell-header h1 {
      font-size: 20px;
      font-weight: 700;
      color: #fff
    }

    .shell-header .meta {
      font-size: 12px;
      color: var(--muted)
    }

    /* Tabs */
    .tab-bar {
      display: flex;
      gap: 2px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      margin-bottom: 10px
    }

    .tab-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 15px;
      font-weight: 600;
      padding: 10px 22px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all .15s
    }

    .tab-btn:hover {
      color: var(--text)
    }

    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent)
    }

    .tab-content {
      display: none;
      flex: 1;
      min-height: 0;
      overflow: auto
    }

    .tab-content.active {
      display: flex;
      flex-direction: column
    }

    /* KPI Row */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 12px;
      flex-shrink: 0
    }

    .kpi {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px
    }

    .kpi-label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 3px
    }

    .kpi-val {
      font-size: 24px;
      font-weight: 800;
      color: #fff;
      line-height: 1.2
    }

    .kpi-sub {
      font-size: 13px;
      font-weight: 600;
      margin-top: 3px
    }

    /* Split Layout */
    .split {
      display: flex;
      gap: 12px;
      flex: 1;
      min-height: 0
    }

    .split-main {
      flex: 3;
      display: flex;
      flex-direction: column;
      min-height: 0
    }

    .split-side {
      flex: 2;
      display: flex;
      flex-direction: column;
      min-height: 0
    }

    /* Card */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px;
      overflow: auto
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px
    }

    /* Table */
    .tbl {
      width: 100%;
      border-collapse: collapse
    }

    .tbl th {
      font-size: 13px;
      color: var(--muted);
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      position: sticky;
      top: 0;
      background: var(--card)
    }

    .tbl td {
      padding: 10px 10px;
      border-bottom: 1px solid rgba(45, 50, 82, .4);
      font-size: 15px;
      vertical-align: middle
    }

    .tbl tr:last-child td {
      border-bottom: none
    }

    .tbl tr:hover td {
      background: rgba(74, 158, 255, .03)
    }

    .stock-name {
      font-weight: 600;
      color: #fff;
      font-size: 15px
    }

    .stock-code {
      font-size: 12px;
      color: var(--muted)
    }

    /* Stock link style */
    .stock-link {
      text-decoration: none;
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 4px;
      border-radius: 4px;
      transition: all .2s
    }

    .stock-link:hover {
      background: rgba(74, 158, 255, .08);
      color: var(--accent)
    }

    .stock-link .link-icon {
      font-size: 12px;
      color: var(--accent)
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 600
    }

    .badge-blue {
      background: rgba(74, 158, 255, .12);
      color: var(--accent);
      border: 1px solid rgba(74, 158, 255, .25)
    }

    .badge-green {
      background: rgba(34, 197, 94, .12);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, .25)
    }

    .badge-red {
      background: rgba(239, 68, 68, .12);
      color: var(--red);
      border: 1px solid rgba(239, 68, 68, .25)
    }

    .badge-orange {
      background: rgba(245, 158, 11, .12);
      color: var(--yellow);
      border: 1px solid rgba(245, 158, 11, .25)
    }

    .badge-gray {
      background: rgba(136, 146, 164, .12);
      color: var(--muted);
      border: 1px solid rgba(136, 146, 164, .25)
    }

    .badge-purple {
      background: rgba(124, 92, 252, .12);
      color: #a78bfa;
      border: 1px solid rgba(124, 92, 252, .25)
    }

    /* Colors */
    .positive {
      color: var(--green)
    }

    .negative {
      color: var(--red)
    }

    .neutral {
      color: var(--muted)
    }

    /* Buttons */
    .btn {
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all .15s
    }

    .btn-accent {
      background: rgba(74, 158, 255, .15);
      color: var(--accent);
      border: 1px solid rgba(74, 158, 255, .3)
    }

    .btn-accent:hover {
      background: rgba(74, 158, 255, .25)
    }

    .btn-green {
      background: rgba(34, 197, 94, .15);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, .3)
    }

    .btn-green:hover {
      background: rgba(34, 197, 94, .25)
    }

    .btn-purple {
      background: rgba(124, 92, 252, .15);
      color: #a78bfa;
      border: 1px solid rgba(124, 92, 252, .3)
    }

    .btn-purple:hover {
      background: rgba(124, 92, 252, .25)
    }

    .sell-btn {
      background: none;
      border: 1px solid rgba(239, 68, 68, .3);
      color: var(--red);
      border-radius: 6px;
      padding: 5px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap
    }

    .sell-btn:hover {
      background: rgba(239, 68, 68, .1)
    }

    /* Trade actions */
    .trade-action-buy {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 700;
      background: rgba(74, 158, 255, .1);
      color: var(--accent);
      border: 1px solid rgba(74, 158, 255, .2)
    }

    .trade-action-sell {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 700;
      background: rgba(239, 68, 68, .1);
      color: var(--red);
      border: 1px solid rgba(239, 68, 68, .2)
    }

    /* Health */
    .health-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px
    }

    .health-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 8px;
      border-radius: 8px;
      gap: 2px
    }

    .health-badge .icon {
      font-size: 22px
    }

    .health-badge .count {
      font-size: 26px;
      font-weight: 800
    }

    .health-badge .hlabel {
      font-size: 13px;
      color: var(--muted)
    }

    .health-green {
      background: rgba(34, 197, 94, .06);
      border: 1px solid rgba(34, 197, 94, .15)
    }

    .health-yellow {
      background: rgba(245, 158, 11, .06);
      border: 1px solid rgba(245, 158, 11, .15)
    }

    .health-orange {
      background: rgba(251, 146, 60, .06);
      border: 1px solid rgba(251, 146, 60, .15)
    }

    .health-red {
      background: rgba(239, 68, 68, .06);
      border: 1px solid rgba(239, 68, 68, .15)
    }

    .health-row {
      background: var(--card2);
      border-radius: 8px;
      padding: 14px 16px;
      margin-bottom: 8px;
      font-size: 15px
    }

    .health-row:last-child {
      margin-bottom: 0
    }

    /* Collapsible */
    .collapse-toggle {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 0
    }

    .collapse-toggle:hover {
      color: var(--text)
    }

    .collapse-body {
      display: none;
      overflow: auto
    }

    .collapse-body.open {
      display: block
    }

    /* Watchlist */
    .wl-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
      overflow: auto
    }

    .watch-card {
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      transition: border-color .2s
    }

    .watch-card:hover {
      border-color: var(--accent)
    }

    .watch-card.status-watching {
      border-left: 3px solid var(--accent)
    }

    .watch-card.status-interested {
      border-left: 3px solid var(--yellow)
    }

    .watch-card.status-archived {
      border-left: 3px solid var(--muted)
    }

    .watch-card .wname {
      font-weight: 700;
      color: #fff;
      font-size: 15px;
      margin-bottom: 4px
    }

    .watch-card .wcode {
      font-size: 12px;
      color: var(--accent);
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
      flex-wrap: wrap
    }

    .watch-card .wnote {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
      margin-bottom: 7px
    }

    .watch-card .wmeta {
      font-size: 11px;
      color: var(--muted)
    }

    .watch-card .wrank {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 700;
      background: rgba(124, 92, 252, .12);
      color: #a78bfa;
      border: 1px solid rgba(124, 92, 252, .25)
    }

    /* Status dropdown */
    .wstatus-wrap {
      position: relative;
      display: inline-block
    }

    .wstatus {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 3px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      user-select: none
    }

    .wstatus:hover {
      opacity: .8
    }

    .wstatus-watching {
      background: rgba(74, 158, 255, .1);
      color: var(--accent);
      border: 1px solid rgba(74, 158, 255, .2)
    }

    .wstatus-interested {
      background: rgba(245, 158, 11, .1);
      color: var(--yellow);
      border: 1px solid rgba(245, 158, 11, .2)
    }

    .wstatus-archived {
      background: rgba(136, 146, 164, .1);
      color: var(--muted);
      border: 1px solid rgba(136, 146, 164, .2)
    }

    .wstatus-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      background: #1a1d2e;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      min-width: 150px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .5);
      display: none;
      z-index: 300
    }

    .wstatus-dropdown.open {
      display: block
    }

    .wstatus-option {
      padding: 12px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s;
      white-space: nowrap
    }

    .wstatus-option:hover {
      background: rgba(255, 255, 255, .05)
    }

    .wstatus-option.active {
      background: rgba(74, 158, 255, .08)
    }

    /* PER */
    .wper {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 12px;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 10px;
      background: rgba(34, 197, 94, .06);
      color: #86efac;
      border: 1px solid rgba(34, 197, 94, .15)
    }

    .wper-red {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 12px;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 10px;
      background: rgba(239, 68, 68, .06);
      color: var(--red);
      border: 1px solid rgba(239, 68, 68, .15)
    }

    .wper-null {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 12px;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 10px;
      background: rgba(136, 146, 164, .06);
      color: var(--muted);
      border: 1px solid rgba(136, 146, 164, .15)
    }

    .arrow-good {
      color: var(--green);
      font-weight: 900
    }

    .arrow-bad {
      color: var(--red);
      font-weight: 900
    }

    .arrow-flat {
      color: var(--muted);
      font-weight: 700
    }

    /* Manifest */
    .manifest-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 14px;
      overflow: auto
    }

    .manifest-card {
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 22px;
      text-decoration: none;
      color: var(--text);
      transition: border-color .25s, transform .15s, box-shadow .25s;
      display: block;
      position: relative;
      overflow: hidden
    }

    .manifest-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      opacity: 0;
      transition: opacity .25s
    }

    .manifest-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(74, 158, 255, .08)
    }

    .manifest-card:hover::before {
      opacity: 1
    }

    .manifest-card .mcard-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px
    }

    .manifest-card .mname {
      font-weight: 700;
      color: #fff;
      font-size: 18px;
      margin-bottom: 4px;
      line-height: 1.3
    }

    .manifest-card .mcode {
      font-size: 12px;
      color: var(--accent);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap
    }

    .manifest-card .mindustry {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px
    }

    .manifest-card .mcatch {
      font-size: 13px;
      color: #94a3c8;
      line-height: 1.6;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden
    }

    .manifest-card .mcatch span {
      color: var(--muted);
      font-size: 11px
    }

    /* Score ring */
    .mscore-ring {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative
    }

    .mscore-ring-inner {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--card2);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column
    }

    .mscore-val {
      font-size: 18px;
      font-weight: 800;
      color: #fff;
      line-height: 1
    }

    .mscore-label {
      font-size: 9px;
      color: var(--muted);
      margin-top: 2px
    }

    /* Axes mini bars */
    .maxes-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 16px;
      margin-bottom: 12px
    }

    .maxe-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px
    }

    .maxe-label {
      color: var(--muted);
      width: 42px;
      flex-shrink: 0;
      text-align: right
    }

    .maxe-bar-bg {
      flex: 1;
      height: 6px;
      background: rgba(255,255,255,.06);
      border-radius: 3px;
      overflow: hidden
    }

    .maxe-bar-fill {
      height: 100%;
      border-radius: 2px;
      transition: width .6s ease
    }

    .maxe-val {
      font-size: 11px;
      font-weight: 700;
      color: #94a3c8;
      width: 24px;
      text-align: right
    }

    .manifest-card .mdate {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 5px;
      padding-top: 10px;
      border-top: 1px solid rgba(45, 50, 82, .4)
    }

    .manifest-card .mcard-loading {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
      padding: 8px 0
    }

    .mcard-loading .mini-spinner {
      width: 12px;
      height: 12px;
      border: 1.5px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite
    }

    @keyframes mcard-fadein {
      from { opacity: 0; transform: translateY(6px) }
      to   { opacity: 1; transform: translateY(0) }
    }

    .mcard-detail {
      animation: mcard-fadein .3s ease
    }

    /* Loading / Error / Empty */
    .loading {
      text-align: center;
      padding: 24px;
      color: var(--muted)
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite;
      margin: 0 auto 8px
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    .error-msg {
      color: var(--red);
      font-size: 11px;
      padding: 10px;
      background: rgba(239, 68, 68, .06);
      border-radius: 8px;
      border: 1px solid rgba(239, 68, 68, .15)
    }

    .empty-msg {
      color: var(--muted);
      font-size: 15px;
      text-align: center;
      padding: 24px
    }

    /* Modal */
    .input-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .65);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center
    }

    .input-modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 28px 24px;
      max-width: 460px;
      width: 92%;
      box-shadow: 0 16px 48px rgba(0, 0, 0, .5)
    }

    .input-modal h3 {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 20px
    }

    .input-modal .field {
      margin-bottom: 16px
    }

    .input-modal label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px
    }

    .input-modal input {
      width: 100%;
      background: #0f1117;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 15px;
      color: var(--text);
      outline: none;
      transition: border-color .15s
    }

    .input-modal input:focus {
      border-color: var(--accent)
    }

    .input-modal .modal-btns {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px
    }

    .modal-btn-cancel {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: none;
      color: var(--muted);
      font-size: 14px;
      cursor: pointer
    }

    .modal-btn-cancel:hover {
      background: rgba(255, 255, 255, .04)
    }

    .modal-btn-ok {
      padding: 10px 22px;
      border-radius: 8px;
      border: none;
      background: var(--green);
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer
    }

    .modal-btn-ok:hover {
      opacity: .85
    }

    .modal-btn-ok:disabled {
      opacity: .4;
      cursor: not-allowed
    }

    .modal-btn-danger {
      padding: 10px 22px;
      border-radius: 8px;
      border: none;
      background: var(--red);
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer
    }

    .modal-btn-danger:hover {
      opacity: .85
    }

    .modal-btn-gray {
      padding: 10px 22px;
      border-radius: 8px;
      border: none;
      background: rgba(136, 146, 164, .2);
      color: var(--muted);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer
    }

    .modal-btn-gray:hover {
      background: rgba(136, 146, 164, .3)
    }

    .modal-error {
      color: var(--red);
      font-size: 13px;
      margin-top: 8px;
      min-height: 16px
    }

    .sell-mode-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 16px
    }

    .sell-tab {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: none;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      text-align: center
    }

    .sell-tab.active-sell {
      background: rgba(239, 68, 68, .12);
      color: var(--red);
      border-color: rgba(239, 68, 68, .3)
    }

    .sell-tab.active-delete {
      background: rgba(136, 146, 164, .1);
      color: var(--muted);
      border-color: rgba(136, 146, 164, .25)
    }



    /* Responsive */
    @media(max-width:768px) {
      .kpi-row {
        grid-template-columns: 1fr 1fr
      }

      .split {
        flex-direction: column
      }

      .tab-btn {
        padding: 8px 12px;
        font-size: 12px
      }
    }

    @media(max-width:480px) {
      .kpi-row {
        grid-template-columns: 1fr
      }
    }
  </style>
</head>

<body>
  <div class="shell">

    <!-- Header -->
    <div class="shell-header">
      <h1><img src="/favicon.svg" alt="" style="width:24px;height:24px;vertical-align:middle;margin-right:6px">æŠ•è³‡ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <span class="meta" id="lastUpdated">èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>

    <!-- Tab Bar -->
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="portfolio" onclick="switchTab('portfolio')">ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</button>
      <button class="tab-btn" data-tab="reports" onclick="switchTab('reports')">åˆ†æãƒ¬ãƒãƒ¼ãƒˆ <span id="reportsCount"
          style="font-size:11px;color:var(--muted)"></span></button>
    </div>

    <!-- TAB 1: Portfolio -->
    <div class="tab-content active" id="tab-portfolio">
      <!-- KPI Row -->
      <div class="kpi-row" id="portfolioSummary">
        <div class="kpi">
          <div class="kpi-label">ä¿æœ‰éŠ˜æŸ„æ•°</div>
          <div class="kpi-val">â€”</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">åˆè¨ˆæŠ•è³‡é¡</div>
          <div class="kpi-val">â€”</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">è©•ä¾¡æç›Š</div>
          <div class="kpi-val">â€”</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">ç·åˆæç›Š</div>
          <div class="kpi-val">â€”</div>
        </div>
      </div>

      <!-- Split: Holdings + HealthCheck -->
      <div class="split">
        <!-- Left: Holdings + Trade History -->
        <div class="split-main">
          <div class="card" style="flex:1;display:flex;flex-direction:column;min-height:0">
            <div class="card-title">
              <span>ä¿æœ‰éŠ˜æŸ„ä¸€è¦§</span>
              <button class="btn btn-green" onclick="onOpenBuyModal()">ï¼‹ è²·ã„è¿½åŠ </button>
            </div>
            <div id="holdingsTable" style="overflow:auto;flex:1">
              <div class="loading">
                <div class="spinner"></div>
              </div>
            </div>
            <!-- Trade History (collapsible) -->
            <div id="tradeHistorySection"
              style="display:none;margin-top:8px;border-top:1px solid var(--border);padding-top:6px">
              <button class="collapse-toggle" onclick="toggleTradeHistory()">
                <span id="tradeToggleIcon">â–¶</span> <span id="tradeToggleLabel">å£²è²·å±¥æ­´</span>
              </button>
              <div class="collapse-body" id="tradeHistoryBody">
                <div id="tradeHistoryTable"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Health Check -->
        <div class="split-side">
          <div class="card" style="flex:1;display:flex;flex-direction:column;min-height:0">
            <div class="card-title">
              <span>ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</span>
              <button class="btn btn-accent" id="healthRunBtn" onclick="onRunHealthCheck()">ğŸ©º å®Ÿè¡Œ</button>
            </div>
            <div id="healthContent" style="overflow:auto;flex:1">
              <div class="empty-msg">ğŸ©º ã€Œå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã§è¨ºæ–­é–‹å§‹<br><span
                  style="font-size:13px">yfinanceã‹ã‚‰å–å¾—ã™ã‚‹ãŸã‚å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>



    <!-- TAB 3: Reports -->
    <div class="tab-content" id="tab-reports">
      <div style="display:flex;align-items:center;margin-bottom:10px;flex-shrink:0">
        <button class="btn btn-purple" id="perUpdateBtn" onclick="onUpdatePer()">ğŸ“Š PERæ›´æ–°</button>
      </div>
      <div class="manifest-list" id="manifestList">
        <div class="loading">
          <div class="spinner"></div>
        </div>
      </div>
    </div>



  </div>

  <script>
    // â”€â”€ Tab switching â”€â”€
    function switchTab(name) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === name));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.toggle('active', t.id === 'tab-' + name));
    }
    function toggleTradeHistory() {
      const body = document.getElementById('tradeHistoryBody');
      const icon = document.getElementById('tradeToggleIcon');
      body.classList.toggle('open');
      icon.textContent = body.classList.contains('open') ? 'â–¼' : 'â–¶';
    }

    // â”€â”€ Data source config â”€â”€
    const RENDER_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:8000' : 'https://stock-dashboard-rif1.onrender.com';

    async function fetchRender(path) {
      const res = await fetch(RENDER_BASE + path);
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      return res.json();
    }

    // â”€â”€ Utilities â”€â”€
    function fmt(n, d = 0) { return n == null ? 'â€”' : Number(n).toLocaleString('ja-JP', { minimumFractionDigits: d, maximumFractionDigits: d }); }
    function fmtPct(n) { return n == null ? 'â€”' : `${n >= 0 ? '+' : ''}${Number(n).toFixed(1)}%`; }
    function gainClass(n) { return n == null ? 'neutral' : n >= 0 ? 'positive' : 'negative'; }
    function rankBadgeColor(r) { return { S: 'badge-green', 'A+': 'badge-green', A: 'badge-green', 'B+': 'badge-blue', B: 'badge-blue', C: 'badge-orange', D: 'badge-red', E: 'badge-red', F: 'badge-red' }[r] || 'badge-gray'; }
    function stockNameHtml(code, name) {
      const url = manifestUrlMap[code];
      if (url) return `<a href="${url}" class="stock-link"><span class="link-icon">ğŸ”—</span><span class="stock-name">${name}</span></a><div class="stock-code">${code}</div>`;
      return `<div class="stock-name">${name}</div><div class="stock-code">${code}</div>`;
    }

    // â”€â”€ Main Load â”€â”€
    let healthData = null;
    let manifestUrlMap = {};
    let watchlistCodesSet = new Set();

    async function loadAll() {
      document.getElementById('lastUpdated').textContent = `æ›´æ–°ä¸­... ${new Date().toLocaleString('ja-JP')}`;
      await loadManifest();
      await loadPortfolio();
      document.getElementById('lastUpdated').textContent = `æœ€çµ‚æ›´æ–°: ${new Date().toLocaleString('ja-JP')}`;
    }

    // â”€â”€ Portfolio â”€â”€
    async function loadPortfolio() {
      const el = document.getElementById('portfolioSummary');
      try {
        const data = await fetchRender('/api/portfolio');
        const holdings = data.holdings || [];
        let totalCost = 0;
        holdings.forEach(h => { totalCost += h.avg_cost * h.shares; });

        const tradeHistory = data.trade_history || [];
        const realizedProfit = tradeHistory.filter(t => t.action === 'sell' && t.profit != null).reduce((s, t) => s + t.profit, 0);
        const tradeCount = tradeHistory.filter(t => t.action === 'sell').length;

        let unrealizedTotal = null, unrealizedCost = 0;
        holdings.forEach(h => {
          if (h.gain_loss != null) { unrealizedTotal = (unrealizedTotal || 0) + h.gain_loss; unrealizedCost += h.avg_cost * h.shares; }
        });

        const combined = (unrealizedTotal ?? 0) + realizedProfit;
        const hasCombined = unrealizedTotal != null || tradeCount > 0;

        el.innerHTML = `
      <div class="kpi"><div class="kpi-label">ä¿æœ‰éŠ˜æŸ„æ•°</div><div class="kpi-val">${holdings.length} éŠ˜æŸ„</div></div>
      <div class="kpi"><div class="kpi-label">åˆè¨ˆæŠ•è³‡é¡</div><div class="kpi-val">Â¥${fmt(totalCost)}</div></div>
      <div class="kpi"><div class="kpi-label">è©•ä¾¡æç›Š</div><div class="kpi-val ${unrealizedTotal != null ? gainClass(unrealizedTotal) : 'neutral'}">${unrealizedTotal != null ? ((unrealizedTotal >= 0 ? '' : '-') + 'Â¥' + fmt(Math.abs(unrealizedTotal))) : 'â€”'}</div>${unrealizedTotal != null && unrealizedCost > 0 ? `<div class="kpi-sub ${gainClass(unrealizedTotal / unrealizedCost * 100)}">${fmtPct(unrealizedTotal / unrealizedCost * 100)}</div>` : ''}</div>
      <div class="kpi"><div class="kpi-label">ç·åˆæç›Š</div><div class="kpi-val ${hasCombined ? gainClass(combined) : 'neutral'}">${hasCombined ? ((combined >= 0 ? '' : '-') + 'Â¥' + fmt(Math.abs(combined))) : 'â€”'}</div></div>`;

        renderHoldingsTable(holdings);
        renderTradeHistory(tradeHistory);
      } catch (e) {
        el.innerHTML = `<div class="kpi" style="grid-column:1/-1"><div class="error-msg">âš ï¸ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªèª­ã¿è¾¼ã¿å¤±æ•—<br><small>${e.message}</small></div></div>`;
        document.getElementById('holdingsTable').innerHTML = '';
      }
    }

    function renderHoldingsTable(holdings) {
      const el = document.getElementById('holdingsTable');
      if (!holdings.length) { el.innerHTML = '<div class="empty-msg">ğŸ“­ ä¿æœ‰éŠ˜æŸ„ãªã—ã€‚ã€Œï¼‹ è²·ã„è¿½åŠ ã€ã‹ã‚‰è¨˜éŒ²ã§ãã¾ã™ã€‚</div>'; return; }
      const rows = holdings.map(h => {
        const evalAmt = h.current_price ? h.current_price * h.shares : null;
        const alertLevel = healthData?.results?.find(r => r.code === h.code)?.alert;
        const alertBadge = alertLevel ? `<span class="badge badge-${alertLevel.level === 'green' ? 'green' : alertLevel.level === 'yellow' ? 'orange' : alertLevel.level === 'orange' ? 'orange' : 'red'}" style="font-size:9px">${alertLevel.label}</span>` : '';
        return `<tr id="tr-hold-${h.code}">
      <td>${stockNameHtml(h.code, h.name)}</td>
      <td>${fmt(h.shares)}æ ª</td><td>Â¥${fmt(h.avg_cost)}</td>
      <td>${h.current_price ? 'Â¥' + fmt(h.current_price) : '<span style="color:var(--muted)">â€”</span>'}</td>
      <td class="${gainClass(h.gain_loss)}">${h.gain_loss != null ? (h.gain_loss >= 0 ? '' : '-') + 'Â¥' + fmt(Math.abs(h.gain_loss)) : 'â€”'}</td>
      <td class="${gainClass(h.gain_loss_pct)}">${h.gain_loss_pct != null ? fmtPct(h.gain_loss_pct) : 'â€”'}</td>
      <td>${alertBadge}</td>
      <td><button class="sell-btn" onclick="onOpenSellModal('${h.code}','${h.name}',${h.shares})">å£²å´</button></td>
    </tr>`;
      }).join('');
      el.innerHTML = `<table class="tbl"><thead><tr><th>éŠ˜æŸ„</th><th>æ ªæ•°</th><th>å–å¾—å˜ä¾¡</th><th>ç¾åœ¨å€¤</th><th>æç›Š</th><th>æç›Šç‡</th><th>çŠ¶æ…‹</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function renderTradeHistory(tradeHistory) {
      const section = document.getElementById('tradeHistorySection');
      const el = document.getElementById('tradeHistoryTable');
      if (!tradeHistory || !tradeHistory.length) { section.style.display = 'none'; return; }
      section.style.display = '';
      document.getElementById('tradeToggleLabel').textContent = `å£²è²·å±¥æ­´ï¼ˆ${tradeHistory.length}ä»¶ï¼‰`;
      const sorted = tradeHistory.map((t, i) => ({ ...t, _origIdx: i })).reverse();
      const rows = sorted.map(t => {
        const isSell = t.action === 'sell';
        const tag = isSell ? `<span class="trade-action-sell">å£²</span>` : `<span class="trade-action-buy">è²·</span>`;
        let profit = '<span style="color:var(--muted)">â€”</span>';
        if (isSell && t.profit != null) { const c = t.profit >= 0 ? 'positive' : 'negative'; profit = `<span class="${c}">${t.profit >= 0 ? '' : '-'}Â¥${fmt(Math.abs(t.profit))}</span>`; }
        return `<tr>
      <td style="color:var(--muted);font-size:11px">${t.date}</td>
      <td>${stockNameHtml(t.code, t.name)}</td>
      <td>${tag}</td><td>${fmt(t.shares)}æ ª</td><td>Â¥${fmt(t.price)}</td>
      <td>${profit}</td>
      <td><button class="sell-btn" data-trade-idx="${t._origIdx}" data-trade-name="${t.name}" data-trade-action="${isSell ? 'å£²' : 'è²·'}" data-trade-shares="${t.shares}" data-trade-date="${t.date}" onclick="onDeleteTrade(this)">å‰Šé™¤</button></td>
    </tr>`;
      }).join('');
      el.innerHTML = `<table class="tbl"><thead><tr><th>æ—¥ä»˜</th><th>éŠ˜æŸ„</th><th>ç¨®åˆ¥</th><th>æ ªæ•°</th><th>å˜ä¾¡</th><th>æç›Š</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    async function onDeleteTrade(btn) {
      const { tradeIdx: idx, tradeName: name, tradeAction: action, tradeShares: shares, tradeDate: date } = btn.dataset;
      const ov = document.createElement('div'); ov.className = 'input-modal-overlay';
      ov.innerHTML = `<div class="input-modal"><h3>ğŸ—‘ï¸ å±¥æ­´ã‚’å‰Šé™¤</h3>
    <p style="font-size:15px;color:#c8cfe0;line-height:1.7;margin-bottom:8px"><strong>${date}</strong> ã® <strong>${name}</strong>ï¼ˆ${action}${shares}æ ªï¼‰ã‚’å±¥æ­´ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚</p>
    <p style="font-size:13px;color:var(--muted);line-height:1.6">â€» ä¿æœ‰éŠ˜æŸ„ã¯æ®‹ã‚Šã®å±¥æ­´ã‹ã‚‰è‡ªå‹•å†è¨ˆç®—ã•ã‚Œã¾ã™ã€‚</p>
    <div class="modal-error" id="dt_err"></div>
    <div class="modal-btns"><button class="modal-btn-cancel" id="dt_cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="modal-btn-danger" id="dt_ok">å‰Šé™¤ã™ã‚‹</button></div></div>`;
      document.body.appendChild(ov);
      const close = () => ov.remove();
      ov.querySelector('#dt_cancel').onclick = close;
      ov.addEventListener('click', e => { if (e.target === ov) close(); });
      ov.querySelector('#dt_ok').onclick = async () => {
        close(); // Optimistic close
        const row = btn.closest('tr');
        if (row) { row.style.opacity = '0.5'; row.style.pointerEvents = 'none'; }
        try {
          const res = await fetch(`${RENDER_BASE}/api/portfolio/trade/${idx}`, { method: 'DELETE', keepalive: true });
          if (!res.ok) { const j = await res.json().catch(() => ({})); throw new Error(j.detail ?? 'å‰Šé™¤å¤±æ•—'); }
          await loadPortfolio();
        } catch (e) { alert(`å‰Šé™¤å¤±æ•—: ${e.message}`); if (row) { row.style.opacity = '1'; row.style.pointerEvents = 'auto'; } await loadPortfolio(); }
      };
    }

    // â”€â”€ Health Check â”€â”€
    async function onRunHealthCheck() {
      const btn = document.getElementById('healthRunBtn');
      const el = document.getElementById('healthContent');
      btn.disabled = true; btn.textContent = 'â³ è¨ºæ–­ä¸­...';
      el.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      try {
        const data = await fetchRender('/api/healthcheck');
        healthData = data;
        const s = data.summary || {};
        let html = `<div class="health-grid">
      <div class="health-badge health-green"><div class="icon">âœ…</div><div class="count" style="color:var(--green)">${s.green ?? 0}</div><div class="hlabel">å•é¡Œãªã—</div></div>
      <div class="health-badge health-yellow"><div class="icon">ğŸŸ¡</div><div class="count" style="color:var(--yellow)">${s.yellow ?? 0}</div><div class="hlabel">æ—©æœŸè­¦å‘Š</div></div>
      <div class="health-badge health-orange"><div class="icon">ğŸŸ </div><div class="count" style="color:#fb923c">${s.orange ?? 0}</div><div class="hlabel">æ³¨æ„</div></div>
      <div class="health-badge health-red"><div class="icon">ğŸ”´</div><div class="count" style="color:var(--red)">${s.red ?? 0}</div><div class="hlabel">æ’¤é€€æ¤œè¨</div></div>
    </div>`;
        if (data.results?.length) {
          html += data.results.map(r => {
            const tech = r.technical || {};
            const col = { green: 'var(--green)', yellow: 'var(--yellow)', orange: '#fb923c', red: 'var(--red)' }[r.alert?.level] || 'var(--muted)';
            const hUrl = manifestUrlMap[r.code];
            const hName = hUrl ? `<a href="${hUrl}" class="stock-link" style="font-weight:700"><span class="link-icon">ğŸ”—</span>${r.name}</a>` : `<strong style="color:#fff">${r.name}</strong>`;
            return `<div class="health-row">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>${hName} <span style="font-size:13px;color:var(--muted)">${r.code}</span></div>
            <span style="font-weight:700;color:${col};font-size:14px">${r.alert?.label ?? 'â€”'}</span>
          </div>
          <div style="font-size:12px;color:#94a3c8;margin-top:4px">${r.alert?.reason ?? ''}</div>
          <div style="display:flex;gap:12px;margin-top:4px;font-size:12px">
            <span>RSI ${tech.rsi ?? 'â€”'}</span>
            <span>${tech.death_cross ? 'ğŸ’€ DC' : tech.golden_cross ? 'âœ¨ GC' : 'SMA â€”'}</span>
            <span>${r.current_price ? 'Â¥' + fmt(r.current_price) : 'â€”'}</span>
          </div>
        </div>`;
          }).join('');
        } else { html += '<div class="empty-msg">ä¿æœ‰éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“</div>'; }
        el.innerHTML = html;
        btn.textContent = 'âœ… å®Œäº†'; btn.style.background = 'rgba(34,197,94,.15)'; btn.style.color = 'var(--green)'; btn.style.borderColor = 'rgba(34,197,94,.3)';
        setTimeout(() => { btn.disabled = false; btn.textContent = 'ğŸ©º å†å®Ÿè¡Œ'; btn.style.background = ''; btn.style.color = ''; btn.style.borderColor = ''; }, 2000);
        loadPortfolio();
      } catch (e) {
        el.innerHTML = `<div class="error-msg">âš ï¸ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—<br><small>${e.message}</small></div>`;
        btn.disabled = false; btn.textContent = 'ğŸ©º å®Ÿè¡Œ';
      }
    }

    // â”€â”€ Watchlist â”€â”€
    const IDX_STATUS_MAP = {
      interested: { label: 'ğŸ’› ç©æ¥µæ¤œè¨', cls: 'wstatus-interested' },
      watching: { label: 'ğŸ‘€ è¦è¦³å¯Ÿ', cls: 'wstatus-watching' },
      archived: { label: 'ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–', cls: 'wstatus-archived' },
    };



    // â”€â”€ Watchlist Status â”€â”€
    function toggleWatchlistStatusDropdown(code) {
      const dd = document.getElementById(`wstd-${code}`); if (!dd) return;
      const isOpen = dd.classList.contains('open');
      document.querySelectorAll('.wstatus-dropdown.open').forEach(el => el.classList.remove('open'));
      if (!isOpen) dd.classList.add('open');
    }
    document.addEventListener('click', e => { if (!e.target.closest('.wstatus-wrap')) document.querySelectorAll('.wstatus-dropdown.open').forEach(el => el.classList.remove('open')); });

    async function onWatchlistStatusClick(opt) {
      const code = opt.dataset.code, newStatus = opt.dataset.status;
      const badgeEl = document.getElementById(`wst-${code}`), ddEl = document.getElementById(`wstd-${code}`);
      if (!badgeEl || !ddEl) return;
      ddEl.classList.remove('open');
      const oldLabel = badgeEl.textContent, oldClass = badgeEl.className;
      const card = badgeEl.closest('.watch-card');
      const oldCardClass = card ? card.className : '';

      // Optimistic update
      const info = IDX_STATUS_MAP[newStatus] || IDX_STATUS_MAP['archived'];
      badgeEl.textContent = info.label + ' â–¾';
      badgeEl.className = `wstatus ${info.cls}`;
      ddEl.querySelectorAll('.wstatus-option').forEach(o => o.classList.toggle('active', o.dataset.status === newStatus));
      
      const wrapEl = badgeEl.closest('.wstatus-wrap') || badgeEl;
      wrapEl.style.opacity = '0.5';
      wrapEl.style.pointerEvents = 'none';

      if (card && newStatus !== 'archived') {
        card.className = oldCardClass.replace(/status-\w+/, `status-${newStatus}`);
      }

      try {
        const res = await fetch(`${RENDER_BASE}/api/watchlist/status`, { method: 'POST', keepalive: true, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code, status: newStatus }) });
        const json = await res.json().catch(()=>({})); if (!json.ok && res.status !== 200) throw new Error(json.detail ?? json.error);
        
        wrapEl.style.opacity = ''; 
        wrapEl.style.pointerEvents = '';
        if (newStatus === 'archived' && card) card.remove();
      } catch (err) {
        badgeEl.textContent = oldLabel; badgeEl.className = oldClass;
        ddEl.querySelectorAll('.wstatus-option').forEach(o => o.classList.remove('active'));
        wrapEl.style.opacity = ''; 
        wrapEl.style.pointerEvents = '';
        if (card) {
          card.className = oldCardClass;
        }
        alert(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å¤±æ•—: ${err.message}`);
      }
    }

    async function onUpdatePer() {
      const btn = document.getElementById('perUpdateBtn');
      btn.disabled = true; btn.textContent = 'â³ é€ä¿¡ä¸­...';
      try {
        const res = await fetch(`${RENDER_BASE}/api/watchlist/update-per`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const json = await res.json().catch(()=>({})); if (!res.ok) throw new Error(json.detail ?? 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—');
        btn.textContent = `âœ… é€ä¿¡å®Œäº†`; btn.style.background = 'rgba(34,197,94,.15)'; btn.style.color = 'var(--green)'; btn.style.borderColor = 'rgba(34,197,94,.3)';
        setTimeout(() => { btn.disabled = false; btn.innerHTML = '<span class="icon">ğŸ“Š</span> PERæ›´æ–°'; btn.style.background = ''; btn.style.color = ''; btn.style.borderColor = ''; }, 5000);
      } catch (e) {
        btn.textContent = `âš ï¸ å¤±æ•—: ${e.message}`; btn.style.background = 'rgba(239,68,68,.15)'; btn.style.color = 'var(--red)';
        setTimeout(() => { btn.disabled = false; btn.innerHTML = '<span class="icon">ğŸ“Š</span> PERæ›´æ–°'; btn.style.background = ''; btn.style.color = ''; btn.style.borderColor = ''; }, 5000);
      }
    }

    // â”€â”€ Manifest â”€â”€
    function scoreColor(s) {
      if (s >= 8) return 'var(--green)';
      if (s >= 6) return 'var(--accent)';
      if (s >= 4) return 'var(--yellow)';
      return 'var(--red)';
    }
    function scoreGrad(s) {
      if (s >= 8) return 'conic-gradient(var(--green) 0%, var(--green) VAL%, rgba(255,255,255,.08) VAL%)'.replace(/VAL/g, (s/10*100).toFixed(0));
      if (s >= 6) return 'conic-gradient(var(--accent) 0%, var(--accent) VAL%, rgba(255,255,255,.08) VAL%)'.replace(/VAL/g, (s/10*100).toFixed(0));
      if (s >= 4) return 'conic-gradient(var(--yellow) 0%, var(--yellow) VAL%, rgba(255,255,255,.08) VAL%)'.replace(/VAL/g, (s/10*100).toFixed(0));
      return 'conic-gradient(var(--red) 0%, var(--red) VAL%, rgba(255,255,255,.08) VAL%)'.replace(/VAL/g, (s/10*100).toFixed(0));
    }
    function axeBarColor(s) {
      if (s >= 8) return 'var(--green)';
      if (s >= 5) return 'var(--accent)';
      if (s >= 3) return 'var(--yellow)';
      return 'var(--red)';
    }
    const AXES_LABELS = { growth: 'æˆé•·æ€§', stability: 'å®‰å®šæ€§', profitability: 'åç›Šæ€§', capacity: 'ä½™åŠ›', innovation: 'æ–°è¦æ€§' };

    function buildPerBadge(w) {
      if (!w || w.per == null) return `<span class="wper-null">PER â€”</span>`;
      const isRed = w.per < 0;
      const hist = w.per_history || [];
      let arrow = '', arrowCls = '';
      if (hist.length >= 2) {
        const prev = hist[hist.length - 2].per, curr = hist[hist.length - 1].per;
        if (prev != null && curr != null) {
          if (isRed || prev < 0) { const ap = Math.abs(prev), ac = Math.abs(curr); if (ac < ap - .05) { arrow = ' â†‘'; arrowCls = 'arrow-good'; } else if (ac > ap + .05) { arrow = ' â†“'; arrowCls = 'arrow-bad'; } else { arrow = ' â†’'; arrowCls = 'arrow-flat'; } }
          else { if (curr < prev - .05) { arrow = ' â†“'; arrowCls = 'arrow-good'; } else if (curr > prev + .05) { arrow = ' â†‘'; arrowCls = 'arrow-bad'; } else { arrow = ' â†’'; arrowCls = 'arrow-flat'; } }
        }
      }
      return `<span class="${isRed ? 'wper-red' : 'wper'}">PER ${w.per}å€<span class="${arrowCls}">${arrow}</span></span>`;
    }

    function buildStatusBadge(code, status) {
      const st = IDX_STATUS_MAP[status] ?? IDX_STATUS_MAP['watching'];
      const statusOptions = Object.entries(IDX_STATUS_MAP).map(([val, info]) =>
        `<div class="wstatus-option${val === (status || 'watching') ? ' active' : ''}" data-code="${code}" data-status="${val}" onclick="event.preventDefault();event.stopPropagation();onWatchlistStatusClick(this)">${info.label}</div>`
      ).join('');
      return `<span class="wstatus-wrap" id="wstwrap-${code}"><span class="wstatus ${st.cls}" id="wst-${code}" onclick="event.preventDefault();event.stopPropagation();toggleWatchlistStatusDropdown('${code}')">${st.label} â–¾</span><div class="wstatus-dropdown" id="wstd-${code}">${statusOptions}</div></span>`;
    }

    async function loadManifest() {
      const el = document.getElementById('manifestList');
      try {
        // Fetch manifest and watchlist in parallel
        const [manifestData, watchlistData] = await Promise.all([
          fetchRender('/api/manifest'),
          fetchRender('/api/watchlist').catch(() => ({ watchlist: [] }))
        ]);
        const stocks = manifestData.stocks || [];
        const watchlist = watchlistData.watchlist || [];
        const wlMap = {};
        watchlist.forEach(w => { wlMap[w.code] = w; });
        manifestUrlMap = {};
        stocks.forEach(s => { if (s.url || s.file) manifestUrlMap[s.code] = s.url ?? s.file; });
        watchlistCodesSet = new Set(watchlist.map(w => w.code));
        const rcEl = document.getElementById('reportsCount');
        if (rcEl) rcEl.textContent = `ï¼ˆ${stocks.length}ï¼‰`;
        if (!stocks.length) { el.innerHTML = '<div class="empty-msg">ğŸ“­ åˆ†æãƒ¬ãƒãƒ¼ãƒˆãªã—ã€‚KabuMartã‚¹ã‚¯ã‚·ãƒ§ã‚’Claudeã«è²¼ã‚Šä»˜ã‘ã‚‹ã¨ç”Ÿæˆã•ã‚Œã¾ã™ã€‚</div>'; return; }
        const sorted = [...stocks].sort((a, b) => (b.analyzed_date ?? '').localeCompare(a.analyzed_date ?? ''));
        // Render skeleton cards
        el.innerHTML = sorted.map(s => {
          const w = wlMap[s.code];
          const statusHtml = w ? buildStatusBadge(s.code, w.status) : '';
          const perHtml = w ? buildPerBadge(w) : '';
          return `<a class="manifest-card" href="${s.url ?? s.file}" data-code="${s.code}" id="mcard-${s.code}">
      <div class="mcard-header">
        <div>
          <div class="mname">${s.name}</div>
          <div class="mcode">${s.code} ${s.kabumart_rank ? `<span class="badge ${rankBadgeColor(s.kabumart_rank)}" style="font-size:11px">${s.kabumart_rank}</span>` : ''} ${statusHtml} ${perHtml}</div>
        </div>
      </div>
      <div class="mcard-loading"><div class="mini-spinner"></div>åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      <div class="mdate">ğŸ“… ${s.analyzed_date ?? 'â€”'}</div>
    </a>`;
        }).join('');
        // Fetch detail data for each card
        sorted.forEach(s => {
          fetchRender(`/api/stocks/${s.code}/data`).then(d => {
            const card = document.getElementById(`mcard-${s.code}`);
            if (!card) return;
            const scores = d.scores || {};
            const axes = scores.axes || {};
            const biz = d.business || {};
            const comp = d.company || {};
            const totalScore = scores.total_score ?? 0;
            let axesHtml = '';
            for (const [key, label] of Object.entries(AXES_LABELS)) {
              const a = axes[key];
              if (!a) continue;
              const pct = (a.score / 10 * 100).toFixed(0);
              axesHtml += `<div class="maxe-row"><span class="maxe-label">${label}</span><div class="maxe-bar-bg"><div class="maxe-bar-fill" style="width:${pct}%;background:${axeBarColor(a.score)}"></div></div><span class="maxe-val">${a.rank}</span></div>`;
            }
            let catchHtml = '';
            if (biz.catchcopy) catchHtml = `<div class="mcatch">${biz.catchcopy}</div>`;
            const indHtml = comp.industry ? `<div class="mindustry">${comp.industry}</div>` : '';
            const loadingEl = card.querySelector('.mcard-loading');
            if (loadingEl) loadingEl.outerHTML = `<div class="mcard-detail">${indHtml}${catchHtml}${axesHtml ? `<div class="maxes-grid">${axesHtml}</div>` : ''}</div>`;
          }).catch(() => {
            const card = document.getElementById(`mcard-${s.code}`);
            if (!card) return;
            const loadingEl = card.querySelector('.mcard-loading');
            if (loadingEl) loadingEl.outerHTML = '';
          });
        });
      } catch (e) { el.innerHTML = `<div class="error-msg">âš ï¸ åˆ†æãƒ¬ãƒãƒ¼ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—<br><small>${e.message}</small></div>`; }
    }

    // â”€â”€ Buy Modal â”€â”€
    function onOpenBuyModal() {
      const ov = document.createElement('div'); ov.className = 'input-modal-overlay';
      ov.innerHTML = `<div class="input-modal"><h3>ï¼‹ ä¿æœ‰éŠ˜æŸ„ã‚’è¿½åŠ </h3>
    <div class="field"><label>éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰</label><input id="bm_code" type="text" placeholder="7203"></div>
    <div class="field"><label>ä¼æ¥­å</label><input id="bm_name" type="text" placeholder="ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š"></div>
    <div class="field"><label>è³¼å…¥æ ªæ•°</label><input id="bm_shares" type="number" min="1" placeholder="100"></div>
    <div class="field"><label>å–å¾—å˜ä¾¡ï¼ˆå††ï¼‰</label><input id="bm_price" type="number" min="0" step="0.01" placeholder="2500"></div>
    <div class="modal-error" id="bm_err"></div>
    <div class="modal-btns"><button class="modal-btn-cancel" id="bm_cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="modal-btn-ok" id="bm_ok">è¿½åŠ ã™ã‚‹</button></div></div>`;
      document.body.appendChild(ov);
      const close = () => ov.remove();
      ov.querySelector('#bm_cancel').onclick = close;
      ov.addEventListener('click', e => { if (e.target === ov) close(); });
      ov.querySelector('#bm_ok').onclick = async () => {
        const code = ov.querySelector('#bm_code').value.trim().toUpperCase(), name = ov.querySelector('#bm_name').value.trim();
        const shares = parseInt(ov.querySelector('#bm_shares').value, 10), price = parseFloat(ov.querySelector('#bm_price').value);
        const err = ov.querySelector('#bm_err'); err.textContent = '';
        if (!code) { err.textContent = 'éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›'; return; } if (!name) { err.textContent = 'ä¼æ¥­åã‚’å…¥åŠ›'; return; }
        if (!shares || shares <= 0) { err.textContent = 'æ ªæ•°ã‚’æ­£ã—ãå…¥åŠ›'; return; } if (isNaN(price) || price <= 0) { err.textContent = 'å–å¾—å˜ä¾¡ã‚’æ­£ã—ãå…¥åŠ›'; return; }
        close(); // Optimistic close after validation
        try {
          const res = await fetch(`${RENDER_BASE}/api/portfolio/buy`, { method: 'POST', keepalive: true, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code, name, shares, price }) });
          const j = await res.json().catch(()=>({})); if (!res.ok) throw new Error(j.detail ?? 'è¿½åŠ å¤±æ•—');
          await loadPortfolio();
        } catch (e) { alert(`è¿½åŠ å¤±æ•—: ${e.message}`); await loadPortfolio(); }
      };
    }

    // â”€â”€ Sell Modal â”€â”€
    function onOpenSellModal(code, name, maxShares) {
      const ov = document.createElement('div'); ov.className = 'input-modal-overlay';
      ov.innerHTML = `<div class="input-modal"><h3>ğŸ“¤ ${name}ï¼ˆ${code}ï¼‰</h3>
    <div class="sell-mode-tabs"><button class="sell-tab active-sell" id="sm_tab_sell">ğŸ’´ å£²å´ã¨ã—ã¦è¨˜éŒ²</button><button class="sell-tab" id="sm_tab_delete" style="color:#8892a4">ğŸ—‘ å…¥åŠ›ãƒŸã‚¹ã§å‰Šé™¤</button></div>
    <div id="sm_sell_form"><div class="field"><label>å£²å´æ ªæ•°ï¼ˆä¿æœ‰:${maxShares}æ ªï¼‰</label><input id="sm_shares" type="number" min="1" max="${maxShares}" value="${maxShares}"></div><div class="field"><label>å£²å´å˜ä¾¡ï¼ˆå††ï¼‰</label><input id="sm_price" type="number" min="0" step="0.01" placeholder="0"></div></div>
    <div id="sm_delete_form" style="display:none"><p style="font-size:12px;color:#94a3c8;line-height:1.5;margin-bottom:8px"><strong>${name}</strong>ã®è¨˜éŒ²ã‚’ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚<br>æç›Šã¯è¨˜éŒ²ã•ã‚Œã¾ã›ã‚“ã€‚</p></div>
    <div class="modal-error" id="sm_err"></div>
    <div class="modal-btns"><button class="modal-btn-cancel" id="sm_cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="modal-btn-danger" id="sm_ok">å£²å´ã‚’è¨˜éŒ²ã™ã‚‹</button></div></div>`;
      document.body.appendChild(ov);
      const close = () => ov.remove();
      ov.querySelector('#sm_cancel').onclick = close;
      ov.addEventListener('click', e => { if (e.target === ov) close(); });
      let mode = 'sell';
      const tabSell = ov.querySelector('#sm_tab_sell'), tabDel = ov.querySelector('#sm_tab_delete');
      const sellForm = ov.querySelector('#sm_sell_form'), delForm = ov.querySelector('#sm_delete_form');
      const okBtn = ov.querySelector('#sm_ok');
      tabSell.onclick = () => { mode = 'sell'; tabSell.className = 'sell-tab active-sell'; tabDel.className = 'sell-tab'; tabDel.style.color = '#8892a4'; sellForm.style.display = ''; delForm.style.display = 'none'; okBtn.removeAttribute('style'); okBtn.className = 'modal-btn-danger'; okBtn.textContent = 'å£²å´ã‚’è¨˜éŒ²ã™ã‚‹'; };
      tabDel.onclick = () => { mode = 'delete'; tabDel.className = 'sell-tab active-delete'; tabSell.className = 'sell-tab'; sellForm.style.display = 'none'; delForm.style.display = ''; okBtn.removeAttribute('style'); okBtn.className = 'modal-btn-gray'; okBtn.textContent = 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‹ã‚‰å‰Šé™¤'; };
      okBtn.onclick = async () => {
        const err = ov.querySelector('#sm_err'); err.textContent = '';
        let sellBody = null;
        if (mode === 'sell') {
          const shares = parseInt(ov.querySelector('#sm_shares').value, 10), price = parseFloat(ov.querySelector('#sm_price').value);
          if (!shares || shares <= 0) { err.textContent = 'æ ªæ•°ã‚’æ­£ã—ãå…¥åŠ›'; return; }
          if (shares > maxShares) { err.textContent = `ä¿æœ‰æ ªæ•°ï¼ˆ${maxShares}æ ªï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™`; return; }
          if (isNaN(price) || price <= 0) { err.textContent = 'å£²å´å˜ä¾¡ã‚’æ­£ã—ãå…¥åŠ›'; return; }
          sellBody = { code, shares, price };
        }
        close(); // Optimistic close after validation

        // Optimistic row update
        const tr = document.getElementById(`tr-hold-${code}`);
        if (tr) { tr.style.opacity = '0.5'; tr.style.pointerEvents = 'none'; }

        try {
          if (mode === 'sell') {
            const res = await fetch(`${RENDER_BASE}/api/portfolio/sell`, { method: 'POST', keepalive: true, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(sellBody) });
            const j = await res.json().catch(()=>({})); if (!res.ok) throw new Error(j.detail ?? 'å£²å´å¤±æ•—');
          } else {
            const res = await fetch(`${RENDER_BASE}/api/portfolio/delete/${code}`, { method: 'DELETE', keepalive: true });
            if (!res.ok) { const j = await res.json().catch(() => ({})); throw new Error(j.detail ?? 'å‰Šé™¤å¤±æ•—'); }
          }
          await loadPortfolio();
        } catch (e) { 
          alert(`å‡¦ç†å¤±æ•—: ${e.message}`); 
          if (tr) { tr.style.opacity = '1'; tr.style.pointerEvents = 'auto'; }
          await loadPortfolio(); 
        }
      };
    }

    // â”€â”€ Init â”€â”€
    loadAll();
  </script>
</body>

</html>