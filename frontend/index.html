<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æŠ•è³‡ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0f1117;
    --card: #1a1d2e;
    --card2: #22263a;
    --accent: #4a9eff;
    --accent2: #7c5cfc;
    --green: #22c55e;
    --red: #ef4444;
    --yellow: #f59e0b;
    --text: #e2e8f0;
    --muted: #8892a4;
    --border: #2d3252;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Hiragino Sans', 'Meiryo', sans-serif; font-size: 14px; line-height: 1.6; }
  .container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .header-card { background: linear-gradient(135deg, #1a1d2e 0%, #0f1a3a 100%); border: 1px solid var(--border); border-radius: 16px; padding: 24px 28px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
  .header-left h1 { font-size: 22px; font-weight: 700; color: #fff; }
  .header-left p { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .header-right { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .last-updated { font-size: 11px; color: var(--muted); }

  /* ãƒãƒƒã‚¸ */
  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
  .badge-blue { background: rgba(74,158,255,0.15); color: var(--accent); border: 1px solid rgba(74,158,255,0.3); }
  .badge-green { background: rgba(34,197,94,0.15); color: var(--green); border: 1px solid rgba(34,197,94,0.3); }
  .badge-red { background: rgba(239,68,68,0.15); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }
  .badge-orange { background: rgba(245,158,11,0.15); color: var(--yellow); border: 1px solid rgba(245,158,11,0.3); }
  .badge-gray { background: rgba(136,146,164,0.15); color: var(--muted); border: 1px solid rgba(136,146,164,0.3); }
  .badge-purple { background: rgba(124,92,252,0.15); color: #a78bfa; border: 1px solid rgba(124,92,252,0.3); }

  /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .section { margin-bottom: 24px; }
  .section-title { font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
  .section-title::before { content: ''; display: block; width: 4px; height: 18px; background: var(--accent); border-radius: 2px; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 18px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
  .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }

  /* ã‚µãƒãƒªãƒ¼KPI */
  .kpi-val { font-size: 22px; font-weight: 800; color: #fff; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .kpi-label { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .kpi-sub { font-size: 13px; font-weight: 600; margin-top: 6px; }
  .positive { color: var(--green); }
  .negative { color: var(--red); }
  .neutral { color: var(--muted); }

  /* ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚µãƒãƒªãƒ¼ */
  .health-layout { display: flex; gap: 16px; align-items: flex-start; }
  .health-badges-grid { flex: 0 0 220px; }
  #healthDetailList { flex: 1; min-width: 0; }
  .health-badge { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 16px 12px; border-radius: 10px; gap: 6px; }
  .health-badge .icon { font-size: 24px; }
  .health-badge .count { font-size: 28px; font-weight: 800; }
  .health-badge .hlabel { font-size: 11px; color: var(--muted); }
  .health-green { background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); }
  .health-yellow { background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.2); }
  .health-orange { background: rgba(251,146,60,0.08); border: 1px solid rgba(251,146,60,0.2); }
  .health-red { background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); }

  /* ä¿æœ‰éŠ˜æŸ„ãƒ†ãƒ¼ãƒ–ãƒ« */
  .holdings-table { width: 100%; border-collapse: collapse; }
  .holdings-table th { font-size: 11px; color: var(--muted); padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
  .holdings-table td { padding: 10px 10px; border-bottom: 1px solid rgba(45,50,82,0.5); font-size: 13px; vertical-align: middle; }
  .holdings-table tr:last-child td { border-bottom: none; }
  .holdings-table tr:hover td { background: rgba(74,158,255,0.04); }
  .stock-name { font-weight: 600; color: #fff; }
  .stock-code { font-size: 11px; color: var(--muted); }

  /* å£²è²·å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« */
  .trade-action-buy  { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; background: rgba(74,158,255,0.12); color: var(--accent); border: 1px solid rgba(74,158,255,0.25); }
  .trade-action-sell { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; background: rgba(239,68,68,0.12); color: var(--red); border: 1px solid rgba(239,68,68,0.25); }

  /* ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è©³ç´° */
  .health-row { background: var(--card2); border-radius: 10px; padding: 14px 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
  .health-row:last-child { margin-bottom: 0; }
  .health-row .name-block { flex: 1; min-width: 140px; }
  .health-row .name-block .name { font-weight: 700; color: #fff; font-size: 14px; }
  .health-row .name-block .code { font-size: 11px; color: var(--muted); }
  .health-row .detail-block { flex: 2; min-width: 200px; }
  .health-row .detail-block .reason { font-size: 12px; color: #94a3c8; margin-top: 4px; }
  .health-row .metrics { display: flex; gap: 12px; flex-wrap: wrap; }
  .metric-item { text-align: center; }
  .metric-item .mval { font-size: 14px; font-weight: 700; color: #fff; }
  .metric-item .mlabel { font-size: 10px; color: var(--muted); }

  /* ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆ */
  .watchlist-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 12px; }
  .watch-card { background: var(--card2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; transition: border-color 0.2s; }
  .watch-card:hover { border-color: var(--accent); }
  .watch-card.status-watching  { border-left: 3px solid var(--accent); }
  .watch-card.status-interested { border-left: 3px solid var(--yellow); }
  .watch-card.status-archived  { border-left: 3px solid var(--muted); }
  .watch-card .wname { font-weight: 700; color: #fff; font-size: 14px; margin-bottom: 4px; }
  .watch-card .wcode { font-size: 11px; color: var(--accent); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  .watch-card .wnote { font-size: 11px; color: var(--muted); line-height: 1.5; margin-bottom: 8px; }
  .watch-card .wmeta { font-size: 10px; color: var(--muted); }
  .watch-card .wrank { display: inline-block; padding: 1px 8px; border-radius: 10px; font-size: 11px; font-weight: 700; background: rgba(124,92,252,0.15); color: #a78bfa; border: 1px solid rgba(124,92,252,0.3); }
  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼‰ */
  .wstatus-wrap { position: relative; display: inline-block; }
  .wstatus { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; cursor: pointer; user-select: none; }
  .wstatus:hover { opacity: 0.8; }
  .wstatus-watching   { background: rgba(74,158,255,0.12); color: var(--accent); border: 1px solid rgba(74,158,255,0.25); }
  .wstatus-interested { background: rgba(245,158,11,0.12); color: var(--yellow); border: 1px solid rgba(245,158,11,0.25); }
  .wstatus-archived   { background: rgba(136,146,164,0.12); color: var(--muted); border: 1px solid rgba(136,146,164,0.25); }
  .wstatus-dropdown { position: absolute; top: calc(100% + 4px); left: 0; background: #1a1d2e; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; min-width: 130px; box-shadow: 0 6px 20px rgba(0,0,0,0.5); display: none; z-index: 300; }
  .wstatus-dropdown.open { display: block; }
  .wstatus-option { padding: 8px 12px; font-size: 11px; font-weight: 600; cursor: pointer; transition: background 0.15s; white-space: nowrap; }
  .wstatus-option:hover { background: rgba(255,255,255,0.06); }
  .wstatus-option.active { background: rgba(74,158,255,0.1); }
  .wstatus-saving { font-size: 10px; color: var(--muted); padding: 2px 6px; }
  /* PERè¡¨ç¤º */
  .wper      { display: inline-flex; align-items: center; gap: 3px; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 10px; background: rgba(34,197,94,0.08);  color: #86efac;        border: 1px solid rgba(34,197,94,0.2); }
  .wper-red  { display: inline-flex; align-items: center; gap: 3px; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 10px; background: rgba(239,68,68,0.08);  color: var(--red);     border: 1px solid rgba(239,68,68,0.2); }
  .wper-null { display: inline-flex; align-items: center; gap: 3px; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 10px; background: rgba(136,146,164,0.08); color: var(--muted);   border: 1px solid rgba(136,146,164,0.2); }
  /* PERçŸ¢å° */
  .arrow-good { color: var(--green);  font-weight: 900; }
  .arrow-bad  { color: var(--red);    font-weight: 900; }
  .arrow-flat { color: var(--muted);  font-weight: 700; }

  /* å€‹åˆ¥åˆ†æãƒšãƒ¼ã‚¸ä¸€è¦§ */
  .manifest-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
  .manifest-card { background: var(--card2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; text-decoration: none; color: var(--text); transition: border-color 0.2s, transform 0.1s; display: block; position: relative; }
  .manifest-card:hover { border-color: var(--accent); transform: translateY(-2px); }
  .manifest-card .mname { font-weight: 700; color: #fff; font-size: 14px; margin-bottom: 4px; }
  .manifest-card .mcode { font-size: 11px; color: var(--accent); margin-bottom: 6px; }
  .manifest-card .mdate { font-size: 10px; color: var(--muted); }

  /* ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒœã‚¿ãƒ³ï¼ˆã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚«ãƒ¼ãƒ‰å³ä¸Šï¼‰ */
  .card-archive-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--muted); font-size: 14px; cursor: pointer; padding: 2px 4px; border-radius: 4px; line-height: 1; opacity: 0.5; transition: opacity 0.15s, color 0.15s; }
  .card-archive-btn:hover { opacity: 1; color: var(--accent); }
  .watch-card { position: relative; }
  .watch-card .wname { padding-right: 24px; }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ã‚¨ãƒ©ãƒ¼ */
  .loading { text-align: center; padding: 40px; color: var(--muted); }
  .loading .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .error-msg { color: var(--red); font-size: 12px; padding: 12px; background: rgba(239,68,68,0.08); border-radius: 8px; border: 1px solid rgba(239,68,68,0.2); }
  .empty-msg { color: var(--muted); font-size: 13px; text-align: center; padding: 24px; }

  /* è¿½åŠ ãƒ»å£²å´ãƒœã‚¿ãƒ³ */
  .add-btn { background: rgba(34,197,94,0.15); color: var(--green); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 5px 12px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .add-btn:hover { background: rgba(34,197,94,0.28); }
  .sell-btn { background: none; border: 1px solid rgba(239,68,68,0.35); color: var(--red); border-radius: 6px; padding: 3px 10px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
  .sell-btn:hover { background: rgba(239,68,68,0.12); }

  /* å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .input-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 1000; display: flex; align-items: center; justify-content: center; }
  .input-modal { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 28px 24px; max-width: 400px; width: 92%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
  .input-modal h3 { font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 18px; }
  .input-modal .field { margin-bottom: 14px; }
  .input-modal label { display: block; font-size: 11px; color: var(--muted); margin-bottom: 5px; }
  .input-modal input { width: 100%; background: #0f1117; border: 1px solid var(--border); border-radius: 8px; padding: 9px 12px; font-size: 14px; color: var(--text); outline: none; transition: border-color 0.15s; }
  .input-modal input:focus { border-color: var(--accent); }
  .input-modal .modal-btns { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
  .modal-btn-cancel { padding: 8px 18px; border-radius: 8px; border: 1px solid var(--border); background: none; color: var(--muted); font-size: 13px; cursor: pointer; }
  .modal-btn-cancel:hover { background: rgba(255,255,255,0.05); }
  .modal-btn-ok { padding: 8px 20px; border-radius: 8px; border: none; background: var(--green); color: #fff; font-size: 13px; font-weight: 700; cursor: pointer; }
  .modal-btn-ok:hover { opacity: 0.85; }
  .modal-btn-ok:disabled { opacity: 0.45; cursor: not-allowed; }
  .modal-btn-danger { padding: 8px 20px; border-radius: 8px; border: none; background: var(--red); color: #fff; font-size: 13px; font-weight: 700; cursor: pointer; }
  .modal-btn-danger:hover { opacity: 0.85; }
  .modal-btn-gray { padding: 8px 20px; border-radius: 8px; border: none; background: rgba(136,146,164,0.2); color: var(--muted); font-size: 13px; font-weight: 700; cursor: pointer; }
  .modal-btn-gray:hover { background: rgba(136,146,164,0.32); }
  .modal-error { color: var(--red); font-size: 12px; margin-top: 8px; min-height: 16px; }
  /* å£²å´ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚¿ãƒ– */
  .sell-mode-tabs { display: flex; gap: 8px; margin-bottom: 18px; }
  .sell-tab { flex: 1; padding: 7px; border-radius: 8px; border: 1px solid var(--border); background: none; color: var(--muted); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s; text-align: center; }
  .sell-tab.active-sell { background: rgba(239,68,68,0.15); color: var(--red); border-color: rgba(239,68,68,0.35); }
  .sell-tab.active-delete { background: rgba(136,146,164,0.12); color: var(--muted); border-color: rgba(136,146,164,0.3); }

  /* ãƒ•ãƒƒã‚¿ãƒ¼ */
  .footer { text-align: center; padding: 20px; color: var(--muted); font-size: 11px; border-top: 1px solid var(--border); margin-top: 32px; line-height: 1.8; }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
  @media (max-width: 768px) {
    .grid-2, .grid-3, .grid-4, .grid-5 { grid-template-columns: 1fr 1fr; }
    .kpi-val { font-size: 18px; }
    .health-layout { flex-direction: column; }
    .health-badges-grid { flex: none; width: 100%; }
  }
  @media (max-width: 480px) {
    .grid-2, .grid-3, .grid-4, .grid-5 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="container">

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header-card">
    <div class="header-left">
      <h1>ğŸ“Š æŠ•è³‡ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <p id="lastUpdated" class="last-updated">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
    <div class="header-right"></div>
  </div>

  <!-- ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µãƒãƒªãƒ¼ -->
  <div class="section">
    <div class="section-title">ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª ã‚µãƒãƒªãƒ¼</div>
    <div class="grid-5" id="portfolioSummary">
      <div class="card"><div class="loading"><div class="spinner"></div></div></div>
      <div class="card"><div class="loading"><div class="spinner"></div></div></div>
      <div class="card"><div class="loading"><div class="spinner"></div></div></div>
      <div class="card"><div class="loading"><div class="spinner"></div></div></div>
      <div class="card"><div class="loading"><div class="spinner"></div></div></div>
    </div>
  </div>

  <!-- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ ã‚µãƒãƒªãƒ¼ -->
  <div class="section">
    <div class="section-title">ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ ã‚µãƒãƒªãƒ¼</div>
    <div class="health-layout">
      <div class="grid-2 health-badges-grid" id="healthSummaryBadges">
        <div class="card"><div class="loading"><div class="spinner"></div></div></div>
      </div>
      <div class="card" id="healthDetailList">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>
  </div>

  <!-- ä¿æœ‰éŠ˜æŸ„ä¸€è¦§ -->
  <div class="section">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
      <div class="section-title" style="margin-bottom:0;">ä¿æœ‰éŠ˜æŸ„ä¸€è¦§</div>
      <button class="add-btn" onclick="onOpenBuyModal()">ï¼‹ è²·ã„è¿½åŠ </button>
    </div>
    <div class="card" id="holdingsTable">
      <div class="loading"><div class="spinner"></div></div>
    </div>
  </div>

  <!-- å£²è²·å±¥æ­´ -->
  <div class="section" id="tradeHistorySection" style="display:none;">
    <div class="section-title">å£²è²·å±¥æ­´</div>
    <div class="card" id="tradeHistoryTable"></div>
  </div>

  <!-- ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆ -->
  <div class="section">
    <div class="section-title">ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆ <span id="watchlistCount" style="font-size:12px; color:var(--muted); font-weight:400;"></span></div>
    <div class="watchlist-grid" id="watchlistGrid">
      <div class="card"><div class="loading"><div class="spinner"></div></div></div>
    </div>
  </div>

  <!-- å€‹åˆ¥éŠ˜æŸ„åˆ†æãƒšãƒ¼ã‚¸ -->
  <div class="section">
    <div class="section-title">å€‹åˆ¥éŠ˜æŸ„ åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</div>
    <div class="manifest-list" id="manifestList">
      <div class="card"><div class="loading"><div class="spinner"></div></div></div>
    </div>
  </div>

  <div class="footer">
    <p>âš ï¸ ã“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯æŠ•è³‡åŠ©è¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æƒ…å ±ã¯å‚è€ƒç›®çš„ã«é™ã‚Šã€å£²è²·ã®æœ€çµ‚åˆ¤æ–­ã¯ã”è‡ªèº«ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
    <p>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼šyfinanceï¼ˆé…å»¶ãƒ‡ãƒ¼ã‚¿ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰/ watchlist.json / portfolio.json</p>
  </div>

</div><!-- /container -->

<script>
// â”€â”€ ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// é™çš„JSONï¼ˆwatchlist/portfolio/manifestï¼‰â†’ GitHub Rawï¼ˆpushç›´å¾Œã«åæ˜ ï¼‰
// yfinanceãŒå¿…è¦ãªAPIï¼ˆhealthcheckï¼‰â†’ Render
const GITHUB_RAW = 'https://raw.githubusercontent.com/bi-al1/stock-dashboard/main';
const RENDER_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:8000'
  : 'https://stock-dashboard-rif1.onrender.com';

// GitHub Raw ã‹ã‚‰ JSON ã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¤ãƒ‘ã‚¹ä»˜ãï¼‰
async function fetchGitHub(path) {
  const url = `${GITHUB_RAW}${path}?_=${Date.now()}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`GitHub fetch error: ${res.status} ${path}`);
  return res.json();
}

// Render API ã‹ã‚‰ JSON ã‚’å–å¾—ï¼ˆyfinanceç³»ã®ã¿ï¼‰
async function fetchRender(path) {
  const res = await fetch(RENDER_BASE + path);
  if (!res.ok) throw new Error(`API error: ${res.status}`);
  return res.json();
}

// â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n, digits=0) {
  if (n == null) return 'â€”';
  return Number(n).toLocaleString('ja-JP', { minimumFractionDigits: digits, maximumFractionDigits: digits });
}
function fmtPct(n) {
  if (n == null) return 'â€”';
  const sign = n >= 0 ? '+' : '';
  return `${sign}${Number(n).toFixed(1)}%`;
}
function gainClass(n) {
  if (n == null) return 'neutral';
  return n >= 0 ? 'positive' : 'negative';
}
function rankBadgeColor(rank) {
  const map = { S:'badge-green', 'A+':'badge-green', A:'badge-green', 'B+':'badge-blue', B:'badge-blue', C:'badge-orange', D:'badge-red', E:'badge-red', F:'badge-red' };
  return map[rank] || 'badge-gray';
}

// â”€â”€ ãƒ¡ã‚¤ãƒ³ãƒ­ãƒ¼ãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let healthData = null;

async function loadAll() {
  document.getElementById('lastUpdated').textContent = `æ›´æ–°ä¸­... ${new Date().toLocaleString('ja-JP')}`;

  // manifest ã‚’å…ˆã«èª­ã‚“ã§URLãƒãƒƒãƒ—ã‚’æ§‹ç¯‰ã—ã¦ã‹ã‚‰ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚’æç”»
  await loadManifest();
  await Promise.all([
    loadPortfolio(),
    loadHealthCheck(),
    loadWatchlist(),
  ]);

  document.getElementById('lastUpdated').textContent = `æœ€çµ‚æ›´æ–°: ${new Date().toLocaleString('ja-JP')}`;
}

// â”€â”€ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPortfolio() {
  const el = document.getElementById('portfolioSummary');
  try {
    const data = await fetchRender('/api/portfolio');
    const holdings = data.holdings || [];

    // å–å¾—åŸä¾¡ãƒ™ãƒ¼ã‚¹ã§åˆè¨ˆï¼ˆç¾åœ¨å€¤ã¯healthcheckã§å¾Œã‹ã‚‰æ›´æ–°ï¼‰
    let totalCost = 0;
    holdings.forEach(h => { totalCost += h.avg_cost * h.shares; });

    // å®Ÿç¾æç›Šï¼ˆå£²å´æ¸ˆã¿ãƒˆãƒ¬ãƒ¼ãƒ‰ã®profitã‚’åˆè¨ˆï¼‰
    const tradeHistory = data.trade_history || [];
    const realizedProfit = tradeHistory
      .filter(t => t.action === 'sell' && t.profit != null)
      .reduce((sum, t) => sum + t.profit, 0);
    const realizedProfitCls = gainClass(realizedProfit);
    const realizedProfitStr = realizedProfit >= 0 ? `Â¥${fmt(realizedProfit)}` : `-Â¥${fmt(Math.abs(realizedProfit))}`;
    const tradeCount = tradeHistory.filter(t => t.action === 'sell').length;

    el.innerHTML = `
      <div class="card">
        <div class="kpi-label">ä¿æœ‰éŠ˜æŸ„æ•°</div>
        <div class="kpi-val">${holdings.length} éŠ˜æŸ„</div>
        <div class="kpi-sub neutral">ç¾åœ¨ä¿æœ‰ä¸­</div>
      </div>
      <div class="card">
        <div class="kpi-label">åˆè¨ˆæŠ•è³‡é¡ï¼ˆå–å¾—åŸä¾¡ï¼‰</div>
        <div class="kpi-val">Â¥${fmt(totalCost)}</div>
        <div class="kpi-sub neutral">å–å¾—åŸä¾¡åˆè¨ˆ</div>
      </div>
      <div class="card">
        <div class="kpi-label">è©•ä¾¡æç›Šï¼ˆç¾åœ¨å€¤ï¼‰</div>
        <div class="kpi-val neutral" id="totalGLKpi">â€”</div>
        <div class="kpi-sub neutral" id="totalGLPctKpi">ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¾Œã«æ›´æ–°</div>
      </div>
      <div class="card">
        <div class="kpi-label">å®Ÿç¾æç›Šï¼ˆå£²å´æ¸ˆã¿ï¼‰</div>
        <div class="kpi-val ${tradeCount === 0 ? 'neutral' : realizedProfitCls}">${tradeCount === 0 ? 'â€”' : realizedProfitStr}</div>
        <div class="kpi-sub neutral">${tradeCount === 0 ? 'å£²å´å±¥æ­´ãªã—' : `${tradeCount}ä»¶ã®å£²å´`}</div>
      </div>
      <div class="card">
        <div class="kpi-label">ç·åˆæç›Šï¼ˆå«ã¿ + å®Ÿç¾ï¼‰</div>
        <div class="kpi-val neutral" id="totalCombinedKpi">â€”</div>
        <div class="kpi-sub neutral" id="totalCombinedSubKpi">ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¾Œã«æ›´æ–°</div>
      </div>
    `;

    // å«ã¿æç›Šã®åˆè¨ˆï¼ˆcurrent_priceãŒå–å¾—ã§ããŸéŠ˜æŸ„ã®ã¿ï¼‰
    let unrealizedTotal = null;
    let unrealizedCost = 0;
    let hasPrice = false;
    holdings.forEach(h => {
      if (h.gain_loss != null) {
        if (!hasPrice) { unrealizedTotal = 0; hasPrice = true; }
        unrealizedTotal += h.gain_loss;
        unrealizedCost += h.avg_cost * h.shares;
      }
    });

    // å«ã¿æç›ŠKPIæ›´æ–°
    const glKpi = document.getElementById('totalGLKpi');
    const glPctKpi = document.getElementById('totalGLPctKpi');
    if (glKpi && unrealizedTotal != null) {
      const pct = unrealizedCost > 0 ? unrealizedTotal / unrealizedCost * 100 : null;
      glKpi.textContent = (unrealizedTotal >= 0 ? 'Â¥' : '-Â¥') + fmt(Math.abs(unrealizedTotal));
      glKpi.className = 'kpi-val ' + gainClass(unrealizedTotal);
      if (glPctKpi && pct != null) {
        glPctKpi.textContent = fmtPct(pct);
        glPctKpi.className = 'kpi-sub ' + gainClass(pct);
      }
    }

    // ç·åˆæç›ŠKPIæ›´æ–°ï¼ˆå«ã¿ + å®Ÿç¾ï¼‰
    const combinedKpi = document.getElementById('totalCombinedKpi');
    const combinedSubKpi = document.getElementById('totalCombinedSubKpi');
    if (combinedKpi && (unrealizedTotal != null || tradeCount > 0)) {
      const combined = (unrealizedTotal ?? 0) + realizedProfit;
      combinedKpi.textContent = (combined >= 0 ? 'Â¥' : '-Â¥') + fmt(Math.abs(combined));
      combinedKpi.className = 'kpi-val ' + gainClass(combined);
      if (combinedSubKpi) {
        const parts = [];
        if (unrealizedTotal != null) parts.push(`å«ã¿ <span class="${gainClass(unrealizedTotal)}">${unrealizedTotal >= 0 ? 'Â¥' : '-Â¥'}${fmt(Math.abs(unrealizedTotal))}</span>`);
        if (tradeCount > 0) parts.push(`å®Ÿç¾ <span class="${gainClass(realizedProfit)}">${realizedProfit >= 0 ? 'Â¥' : '-Â¥'}${fmt(Math.abs(realizedProfit))}</span>`);
        combinedSubKpi.innerHTML = parts.join('<br>');
        combinedSubKpi.className = 'kpi-sub neutral';
      }
    }

    // ä¿æœ‰éŠ˜æŸ„ãƒ†ãƒ¼ãƒ–ãƒ« & å£²è²·å±¥æ­´
    renderHoldingsTable(holdings);
    renderTradeHistory(tradeHistory);
  } catch(e) {
    el.innerHTML = `<div class="card"><div class="error-msg">âš ï¸ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br><small>${e.message}</small></div></div>`;
    document.getElementById('holdingsTable').innerHTML = '';
  }
}

function renderHoldingsTable(holdings) {
  const el = document.getElementById('holdingsTable');
  if (!holdings.length) {
    el.innerHTML = '<div class="empty-msg">ğŸ“­ ä¿æœ‰éŠ˜æŸ„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>å³ä¸Šã®ã€Œï¼‹ è²·ã„è¿½åŠ ã€ã‹ã‚‰è¨˜éŒ²ã§ãã¾ã™ã€‚</div>';
    return;
  }

  const rows = holdings.map(h => {
    const evalAmt = h.current_price ? h.current_price * h.shares : null;
    const alertLevel = healthData?.results?.find(r => r.code === h.code)?.alert;
    const alertBadge = alertLevel
      ? `<span class="badge badge-${alertLevel.level === 'green' ? 'green' : alertLevel.level === 'yellow' ? 'orange' : alertLevel.level === 'orange' ? 'orange' : 'red'}" style="font-size:10px;">${alertLevel.label}</span>`
      : '';

    return `
      <tr>
        <td>
          <div class="stock-name">${h.name}</div>
          <div class="stock-code">${h.code}</div>
        </td>
        <td>${fmt(h.shares)} æ ª</td>
        <td>Â¥${fmt(h.avg_cost)}</td>
        <td>${h.current_price ? 'Â¥' + fmt(h.current_price) : '<span style="color:var(--muted)">å–å¾—ä¸­</span>'}</td>
        <td class="${gainClass(h.gain_loss)}">${h.gain_loss != null ? (h.gain_loss >= 0 ? '' : '-') + 'Â¥' + fmt(Math.abs(h.gain_loss)) : 'â€”'}</td>
        <td class="${gainClass(h.gain_loss_pct)}">${h.gain_loss_pct != null ? fmtPct(h.gain_loss_pct) : 'â€”'}</td>
        <td>${evalAmt ? 'Â¥' + fmt(evalAmt) : 'â€”'}</td>
        <td>${alertBadge}</td>
        <td><button class="sell-btn" onclick="onOpenSellModal('${h.code}','${h.name}',${h.shares})">å£²å´</button></td>
      </tr>`;
  }).join('');

  el.innerHTML = `
    <table class="holdings-table">
      <thead>
        <tr>
          <th>éŠ˜æŸ„</th><th>æ ªæ•°</th><th>å–å¾—å˜ä¾¡</th><th>ç¾åœ¨å€¤</th>
          <th>è©•ä¾¡æç›Š</th><th>è©•ä¾¡æç›Šç‡</th><th>è©•ä¾¡é¡</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th></th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
}

function renderTradeHistory(tradeHistory) {
  const section = document.getElementById('tradeHistorySection');
  const el = document.getElementById('tradeHistoryTable');
  if (!tradeHistory || !tradeHistory.length) {
    section.style.display = 'none';
    return;
  }
  section.style.display = '';

  // æ–°ã—ã„é †ã«ä¸¦ã¹æ›¿ãˆ
  const sorted = [...tradeHistory].reverse();

  const rows = sorted.map(t => {
    const isSell = t.action === 'sell';
    const actionTag = isSell
      ? `<span class="trade-action-sell">å£²</span>`
      : `<span class="trade-action-buy">è²·</span>`;
    const totalAmt = `Â¥${fmt(t.price * t.shares)}`;
    let profitCell = '<span style="color:var(--muted)">â€”</span>';
    if (isSell && t.profit != null) {
      const cls = t.profit >= 0 ? 'positive' : 'negative';
      const sign = t.profit >= 0 ? '' : '-';
      profitCell = `<span class="${cls}">${sign}Â¥${fmt(Math.abs(t.profit))}</span>`;
    }
    return `
      <tr>
        <td style="color:var(--muted); font-size:12px;">${t.date}</td>
        <td>
          <div class="stock-name">${t.name}</div>
          <div class="stock-code">${t.code}</div>
        </td>
        <td>${actionTag}</td>
        <td>${fmt(t.shares)} æ ª</td>
        <td>Â¥${fmt(t.price)}</td>
        <td>${totalAmt}</td>
        <td>${profitCell}</td>
      </tr>`;
  }).join('');

  el.innerHTML = `
    <table class="holdings-table">
      <thead>
        <tr>
          <th>æ—¥ä»˜</th><th>éŠ˜æŸ„</th><th>ç¨®åˆ¥</th><th>æ ªæ•°</th><th>å˜ä¾¡</th><th>ç´„å®šé‡‘é¡</th><th>æç›Š</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
}

// â”€â”€ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHealthCheck() {
  const badgesEl = document.getElementById('healthSummaryBadges');
  const listEl = document.getElementById('healthDetailList');
  try {
    const data = await fetchRender('/api/healthcheck');
    healthData = data;
    const s = data.summary || {};

    badgesEl.innerHTML = `
      <div class="health-badge health-green"><div class="icon">âœ…</div><div class="count" style="color:var(--green)">${s.green ?? 0}</div><div class="hlabel">å•é¡Œãªã—</div></div>
      <div class="health-badge health-yellow"><div class="icon">ğŸŸ¡</div><div class="count" style="color:var(--yellow)">${s.yellow ?? 0}</div><div class="hlabel">æ—©æœŸè­¦å‘Š</div></div>
      <div class="health-badge health-orange"><div class="icon">ğŸŸ </div><div class="count" style="color:#fb923c">${s.orange ?? 0}</div><div class="hlabel">æ³¨æ„</div></div>
      <div class="health-badge health-red"><div class="icon">ğŸ”´</div><div class="count" style="color:var(--red)">${s.red ?? 0}</div><div class="hlabel">æ’¤é€€æ¤œè¨</div></div>
    `;

    if (!data.results?.length) {
      listEl.innerHTML = '<div class="empty-msg">ä¿æœ‰éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    const items = data.results.map(r => {
      const tech = r.technical || {};
      const rsiVal = tech.rsi != null ? `RSI ${tech.rsi}` : 'RSI â€”';
      const smaVal = tech.death_cross ? 'ğŸ’€ ãƒ‡ãƒƒãƒ‰ã‚¯ãƒ­ã‚¹' : tech.golden_cross ? 'âœ¨ ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹' : 'SMA åˆ¤å®šä¸­';
      const price = r.current_price ? `Â¥${fmt(r.current_price)}` : 'â€”';
      const alertColors = { green:'var(--green)', yellow:'var(--yellow)', orange:'#fb923c', red:'var(--red)' };
      const col = alertColors[r.alert?.level] || 'var(--muted)';

      return `
        <div class="health-row">
          <div class="name-block">
            <div class="name">${r.name}</div>
            <div class="code">${r.code}</div>
          </div>
          <div class="detail-block">
            <span style="font-weight:700; color:${col};">${r.alert?.label ?? 'â€”'}</span>
            <div class="reason">${r.alert?.reason ?? ''}</div>
          </div>
          <div class="metrics">
            <div class="metric-item"><div class="mval">${price}</div><div class="mlabel">ç¾åœ¨å€¤</div></div>
            <div class="metric-item"><div class="mval">${rsiVal}</div><div class="mlabel">ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«</div></div>
            <div class="metric-item"><div class="mval" style="font-size:11px;">${smaVal}</div><div class="mlabel">SMA</div></div>
          </div>
        </div>`;
    }).join('');

    listEl.innerHTML = items;

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒƒã‚¸ã‚’å†æç”»ï¼ˆhealthDataãŒæƒã£ãŸã®ã§ï¼‰
    const portfolioData = document.querySelector('.holdings-table');
    if (portfolioData) {
      // ä¿æœ‰éŠ˜æŸ„ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†å–å¾—ã—ã¦å†æç”»
      loadPortfolio();
    }

  } catch(e) {
    badgesEl.innerHTML = `<div class="error-msg">âš ï¸ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—<br><small>${e.message}</small></div>`;
    listEl.innerHTML = '';
  }
}

// â”€â”€ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// manifest ã® stocks ã‚’ code â†’ url ã§å¼•ã‘ã‚‹ã‚ˆã†ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
let manifestUrlMap = {};
// ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã®codeã‚»ãƒƒãƒˆ
let watchlistCodesSet = new Set();

async function loadWatchlist() {
  const el = document.getElementById('watchlistGrid');
  const countEl = document.getElementById('watchlistCount');
  try {
    const data = await fetchRender('/api/watchlist');
    const rawList = data.watchlist || [];
    // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ãƒ»å³æ™‚ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ã‚’é™¤å¤–ã—ã¦æç”»
    const list = rawList.filter(w => w.status !== 'archived' && !_archivedCodes.has(w.code));
    watchlistCodesSet = new Set(rawList.map(w => w.code));
    countEl.textContent = `ï¼ˆ${list.length} éŠ˜æŸ„ï¼‰`;

    if (!list.length) {
      el.innerHTML = '<div class="card"><div class="empty-msg">ğŸ“­ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã¯ç©ºã§ã™ã€‚<br>åˆ†æå¾Œã«ã€Œã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¦ã€ã¨Claudeã«ä¼ãˆã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div></div>';
      return;
    }

    const STATUS_MAP = {
      interested: { label: 'ğŸ’› ç©æ¥µæ¤œè¨', cls: 'wstatus-interested' },
      watching:   { label: 'ğŸ‘€ è¦è¦³å¯Ÿ',   cls: 'wstatus-watching'   },
      archived:   { label: 'ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–', cls: 'wstatus-archived' },
    };

    el.innerHTML = list.map(w => {
      const reportUrl = manifestUrlMap[w.code];
      const tag = reportUrl ? 'a' : 'div';
      const hrefAttr = reportUrl ? `href="${reportUrl}" target="_blank"` : '';
      const reportBadge = reportUrl
        ? `<div class="wmeta" style="color:var(--accent); margin-top:6px; font-size:11px;">ğŸ“Š åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚ã‚Š â†’</div>`
        : '';

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´å¯èƒ½ï¼‰
      const st = STATUS_MAP[w.status] ?? STATUS_MAP['watching'];
      const statusOptions = Object.entries(STATUS_MAP).map(([val, info]) =>
        `<div class="wstatus-option${val === (w.status||'watching') ? ' active' : ''}" data-code="${w.code}" data-status="${val}" onclick="event.preventDefault();event.stopPropagation();onWatchlistStatusClick(this)">${info.label}</div>`
      ).join('');
      const statusBadge = `
        <span class="wstatus-wrap" id="wstwrap-${w.code}">
          <span class="wstatus ${st.cls}" id="wst-${w.code}" onclick="event.preventDefault();event.stopPropagation();toggleWatchlistStatusDropdown('${w.code}')">${st.label} â–¾</span>
          <div class="wstatus-dropdown" id="wstd-${w.code}">${statusOptions}</div>
        </span>`;

      // äºˆæƒ³PER ãƒãƒƒã‚¸ï¼ˆæ•°å€¤è¡¨ç¤º + per_history 2ä»¶æ¯”è¼ƒã§çŸ¢å°ï¼‰
      let perBadge = '';
      if (w.per == null) {
        perBadge = `<span class="wper-null">PER â€”</span>`;
      } else {
        const perVal = w.per;
        const isRed = perVal < 0;
        const dispVal = `${perVal > 0 ? '' : ''}${perVal}å€`;

        // çŸ¢å°åˆ¤å®šï¼ˆper_history ãŒ2ä»¶ä»¥ä¸Šã‚ã‚‹å ´åˆï¼‰
        const hist = w.per_history || [];
        let arrow = '', arrowCls = '';
        if (hist.length >= 2) {
          const prev = hist[hist.length - 2].per;
          const curr = hist[hist.length - 1].per;
          if (prev != null && curr != null) {
            if (isRed || prev < 0) {
              // èµ¤å­—åŒå£« or å‰å›èµ¤å­—ï¼šçµ¶å¯¾å€¤ã§åˆ¤å®šï¼ˆå°ã•ã„æ–¹ãŒæ”¹å–„ï¼‰
              const absPrev = Math.abs(prev), absCurr = Math.abs(curr);
              if (absCurr < absPrev - 0.05)      { arrow = ' â†‘'; arrowCls = 'arrow-good'; }
              else if (absCurr > absPrev + 0.05) { arrow = ' â†“'; arrowCls = 'arrow-bad'; }
              else                                { arrow = ' â†’'; arrowCls = 'arrow-flat'; }
            } else {
              // é»’å­—åŒå£«ï¼šPERå°ã•ã„ã»ã©å‰²å®‰
              if (curr < prev - 0.05)      { arrow = ' â†“'; arrowCls = 'arrow-good'; } // ä¸‹ãŒã£ãŸ=å‰²å®‰åŒ–
              else if (curr > prev + 0.05) { arrow = ' â†‘'; arrowCls = 'arrow-bad'; }  // ä¸ŠãŒã£ãŸ=å‰²é«˜åŒ–
              else                          { arrow = ' â†’'; arrowCls = 'arrow-flat'; }
            }
          }
        }

        const baseCls = isRed ? 'wper-red' : 'wper';
        perBadge = `<span class="${baseCls}">PER ${dispVal}<span class="${arrowCls}">${arrow}</span></span>`;
      }

      return `
        <${tag} class="watch-card status-${w.status ?? 'watching'}" ${hrefAttr} data-code="${w.code}" style="${reportUrl ? 'text-decoration:none;' : ''}">
          <button class="card-archive-btn" title="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–" onclick="event.preventDefault();event.stopPropagation();onArchiveWatchlist('${w.code}')">ğŸ“¦</button>
          <div class="wname">${w.name}</div>
          <div class="wcode">
            ${w.code}
            ${w.kabumart_rank ? `<span class="wrank">${w.kabumart_rank}</span>` : ''}
            ${statusBadge}
            ${perBadge}
          </div>
          ${w.note ? `<div class="wnote">${w.note}</div>` : ''}
          <div class="wmeta">è¿½åŠ æ—¥: ${w.added_date ?? 'â€”'}</div>
          ${reportBadge}
        </${tag}>`;
    }).join('');
  } catch(e) {
    el.innerHTML = `<div class="card"><div class="error-msg">âš ï¸ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—<br><small>${e.message}</small></div>`;
  }
}

// â”€â”€ manifestï¼ˆå€‹åˆ¥åˆ†æãƒšãƒ¼ã‚¸ä¸€è¦§ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadManifest() {
  const el = document.getElementById('manifestList');
  try {
    // GitHub Raw ã§ã¯ãªã Render API çµŒç”±ã§å–å¾—ã™ã‚‹ã€‚
    // ç†ç”±: delete_report ãŒ manifest.json ã‚’æ›´æ–°ã—ãŸç›´å¾Œã« loadAll() ãŒèµ°ã‚‹ã¨ã€
    //       GitHub Raw CDN ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆæ•°åç§’ã€œæ•°åˆ†ï¼‰ã«ã‚ˆã‚Šå¤ã„ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã‚Š
    //       å‰Šé™¤ã—ãŸã‚«ãƒ¼ãƒ‰ãŒå¾©æ´»ã—ã¦ã—ã¾ã†å•é¡Œã‚’æ ¹æœ¬è§£æ±ºã™ã‚‹ãŸã‚ã€‚
    // Render ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã® manifest.json ã‚’ save_json() ã§æ›´æ–°æ¸ˆã¿ãªã®ã§å¸¸ã«æœ€æ–°ã‚’è¿”ã™ã€‚
    const data = await fetchRender('/api/manifest');
    const stocks = data.stocks || [];

    // ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã®ãƒªãƒ³ã‚¯ç”¨ã« code â†’ url ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    manifestUrlMap = {};
    stocks.forEach(s => {
      if (s.url || s.file) manifestUrlMap[s.code] = s.url ?? s.file;
    });

    if (!stocks.length) {
      el.innerHTML = '<div class="card"><div class="empty-msg">ğŸ“­ ã¾ã åˆ†æãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>KabuMartã®ã‚¹ã‚¯ã‚·ãƒ§ã‚’Claudeã«è²¼ã‚Šä»˜ã‘ã‚‹ã¨åˆ†æãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚</div></div>';
      return;
    }

    // æ–°ã—ã„é †ã«ä¸¦ã¹æ›¿ãˆï¼ˆå‰Šé™¤æ¸ˆã¿codeã¯é™¤å¤–ï¼‰
    const sorted = [...stocks]
      .sort((a, b) => (b.analyzed_date ?? '').localeCompare(a.analyzed_date ?? ''));
    el.innerHTML = sorted.map(s => {
      return `
      <a class="manifest-card" href="${s.url ?? s.file}" target="_blank" data-code="${s.code}">
        <div class="mname">${s.name}</div>
        <div class="mcode">${s.code} ${s.kabumart_rank ? `<span class="badge ${rankBadgeColor(s.kabumart_rank)}" style="font-size:10px;">${s.kabumart_rank}</span>` : ''}</div>
        <div class="mdate">ğŸ“… åˆ†ææ—¥: ${s.analyzed_date ?? 'â€”'}</div>
      </a>`;
    }).join('');
  } catch(e) {
    el.innerHTML = `<div class="card"><div class="error-msg">âš ï¸ åˆ†æãƒ¬ãƒãƒ¼ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿å¤±æ•—<br><small>${e.message}</small></div>`;
  }
}

// â”€â”€ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const IDX_STATUS_MAP = {
  interested: { label: 'ğŸ’› ç©æ¥µæ¤œè¨', cls: 'wstatus-interested' },
  watching:   { label: 'ğŸ‘€ è¦è¦³å¯Ÿ',   cls: 'wstatus-watching'   },
  archived:   { label: 'ğŸ“¦ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–', cls: 'wstatus-archived' },
};

function toggleWatchlistStatusDropdown(code) {
  const dd = document.getElementById(`wstd-${code}`);
  if (!dd) return;
  const isOpen = dd.classList.contains('open');
  // ä»–ã‚’å…¨éƒ¨é–‰ã˜ã‚‹
  document.querySelectorAll('.wstatus-dropdown.open').forEach(el => el.classList.remove('open'));
  if (!isOpen) dd.classList.add('open');
}

// ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.addEventListener('click', e => {
  // wstatus-wrap ã®å†…å´ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–ï¼ˆwstatus ã¨ wstatus-option ã¯å„è‡ª stopPropagation æ¸ˆã¿ï¼‰
  if (!e.target.closest('.wstatus-wrap')) {
    document.querySelectorAll('.wstatus-dropdown.open').forEach(el => el.classList.remove('open'));
  }
});

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼ˆç›´æ¥ onclick ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
async function onWatchlistStatusClick(opt) {
  const code = opt.dataset.code;
  const newStatus = opt.dataset.status;
  const badgeEl = document.getElementById(`wst-${code}`);
  const ddEl = document.getElementById(`wstd-${code}`);
  if (!badgeEl || !ddEl) return;

  ddEl.classList.remove('open');

  const oldLabel = badgeEl.textContent;
  badgeEl.textContent = 'æ›´æ–°ä¸­...';

  try {
    const res = await fetch(`${RENDER_BASE}/api/watchlist/status`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, status: newStatus }),
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.detail ?? json.error);

    // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ã—ãŸã‚‰ã‚«ãƒ¼ãƒ‰ã‚’éè¡¨ç¤º
    if (newStatus === 'archived') {
      const card = badgeEl.closest('.watch-card');
      if (card) card.remove();
      _archivedCodes.add(code);
      return;
    }

    // ãƒãƒƒã‚¸æ›´æ–°
    const info = IDX_STATUS_MAP[newStatus];
    badgeEl.textContent = info.label + ' â–¾';
    badgeEl.className = `wstatus ${info.cls}`;
    // ã‚«ãƒ¼ãƒ‰ã®å·¦ãƒœãƒ¼ãƒ€ãƒ¼æ›´æ–°
    const card = badgeEl.closest('.watch-card');
    if (card) {
      card.className = card.className.replace(/status-\w+/, `status-${newStatus}`);
    }
    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®activeæ›´æ–°
    ddEl.querySelectorAll('.wstatus-option').forEach(o => {
      o.classList.toggle('active', o.dataset.status === newStatus);
    });

  } catch(err) {
    badgeEl.textContent = oldLabel;
    alert(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
  }
}

// â”€â”€ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å³æ™‚ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿codeã‚»ãƒƒãƒˆï¼ˆloadAllå¾Œã«ã‚‚å†é™¤å»ã™ã‚‹ãŸã‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
const _archivedCodes = new Set();

async function onArchiveWatchlist(code) {
  // ã‚«ãƒ¼ãƒ‰ã‚’å³åº§ã«éè¡¨ç¤º
  const card = document.querySelector(`.watch-card[data-code="${code}"]`);
  if (card) card.remove();
  _archivedCodes.add(code);

  try {
    const res = await fetch(`${RENDER_BASE}/api/watchlist/status`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, status: 'archived' }),
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.detail ?? json.error);
  } catch(e) {
    alert(`ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å¤±æ•—: ${e.message}`);
  }
}

// â”€â”€ è²·ã„è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onOpenBuyModal() {
  const overlay = document.createElement('div');
  overlay.className = 'input-modal-overlay';
  overlay.innerHTML = `
    <div class="input-modal">
      <h3>ï¼‹ ä¿æœ‰éŠ˜æŸ„ã‚’è¿½åŠ </h3>
      <div class="field">
        <label>éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼š7203ï¼‰</label>
        <input id="bm_code" type="text" placeholder="7203" autocomplete="off">
      </div>
      <div class="field">
        <label>ä¼æ¥­å</label>
        <input id="bm_name" type="text" placeholder="ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š" autocomplete="off">
      </div>
      <div class="field">
        <label>è³¼å…¥æ ªæ•°</label>
        <input id="bm_shares" type="number" min="1" placeholder="100">
      </div>
      <div class="field">
        <label>å–å¾—å˜ä¾¡ï¼ˆå††ï¼‰</label>
        <input id="bm_price" type="number" min="0" step="0.01" placeholder="2500">
      </div>
      <div class="modal-error" id="bm_err"></div>
      <div class="modal-btns">
        <button class="modal-btn-cancel" id="bm_cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn-ok" id="bm_ok">è¿½åŠ ã™ã‚‹</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);

  const close = () => overlay.remove();
  overlay.querySelector('#bm_cancel').onclick = close;
  overlay.addEventListener('click', e => { if (e.target === overlay) close(); });

  overlay.querySelector('#bm_ok').onclick = async () => {
    const code   = overlay.querySelector('#bm_code').value.trim().toUpperCase();
    const name   = overlay.querySelector('#bm_name').value.trim();
    const shares = parseInt(overlay.querySelector('#bm_shares').value, 10);
    const price  = parseFloat(overlay.querySelector('#bm_price').value);
    const errEl  = overlay.querySelector('#bm_err');
    errEl.textContent = '';

    if (!code)           { errEl.textContent = 'éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
    if (!name)           { errEl.textContent = 'ä¼æ¥­åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
    if (!shares || shares <= 0) { errEl.textContent = 'æ ªæ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
    if (isNaN(price) || price <= 0) { errEl.textContent = 'å–å¾—å˜ä¾¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'; return; }

    const btn = overlay.querySelector('#bm_ok');
    btn.disabled = true;
    btn.textContent = 'è¿½åŠ ä¸­...';

    try {
      const res = await fetch(`${RENDER_BASE}/api/portfolio/buy`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code, name, shares, price }),
      });
      const j = await res.json();
      if (!res.ok) throw new Error(j.detail ?? 'è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      close();
      await loadPortfolio();
    } catch(e) {
      errEl.textContent = e.message;
      btn.disabled = false;
      btn.textContent = 'è¿½åŠ ã™ã‚‹';
    }
  };
}

// â”€â”€ å£²å´ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onOpenSellModal(code, name, maxShares) {
  const overlay = document.createElement('div');
  overlay.className = 'input-modal-overlay';
  overlay.innerHTML = `
    <div class="input-modal">
      <h3>ğŸ“¤ ${name}ï¼ˆ${code}ï¼‰</h3>
      <div class="sell-mode-tabs">
        <button class="sell-tab active-sell" id="sm_tab_sell">ğŸ’´ å£²å´ã¨ã—ã¦è¨˜éŒ²</button>
        <button class="sell-tab" id="sm_tab_delete" style="color:#8892a4">ğŸ—‘ å…¥åŠ›ãƒŸã‚¹ã§å‰Šé™¤</button>
      </div>
      <!-- å£²å´ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div id="sm_sell_form">
        <div class="field">
          <label>å£²å´æ ªæ•°ï¼ˆä¿æœ‰: ${maxShares}æ ªï¼‰</label>
          <input id="sm_shares" type="number" min="1" max="${maxShares}" placeholder="${maxShares}" value="${maxShares}">
        </div>
        <div class="field">
          <label>å£²å´å˜ä¾¡ï¼ˆå††ï¼‰</label>
          <input id="sm_price" type="number" min="0" step="0.01" placeholder="0">
        </div>
      </div>
      <!-- å‰Šé™¤ç¢ºèª -->
      <div id="sm_delete_form" style="display:none">
        <p style="font-size:13px; color:#94a3c8; line-height:1.6; margin-bottom:8px;">
          <strong>${name}</strong> ã®è¨˜éŒ²ã‚’ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚<br>
          æç›Šã¯è¨˜éŒ²ã•ã‚Œã¾ã›ã‚“ã€‚
        </p>
      </div>
      <div class="modal-error" id="sm_err"></div>
      <div class="modal-btns">
        <button class="modal-btn-cancel" id="sm_cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn-danger" id="sm_ok">å£²å´ã‚’è¨˜éŒ²ã™ã‚‹</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);

  const close = () => overlay.remove();
  overlay.querySelector('#sm_cancel').onclick = close;
  overlay.addEventListener('click', e => { if (e.target === overlay) close(); });

  let mode = 'sell'; // 'sell' | 'delete'
  const tabSell   = overlay.querySelector('#sm_tab_sell');
  const tabDelete = overlay.querySelector('#sm_tab_delete');
  const sellForm  = overlay.querySelector('#sm_sell_form');
  const deleteForm = overlay.querySelector('#sm_delete_form');
  const okBtn     = overlay.querySelector('#sm_ok');

  tabSell.onclick = () => {
    mode = 'sell';
    tabSell.className   = 'sell-tab active-sell';
    tabDelete.className = 'sell-tab';
    tabDelete.style.color = '#8892a4';
    sellForm.style.display  = '';
    deleteForm.style.display = 'none';
    okBtn.removeAttribute('style'); // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚¯ãƒ©ã‚¹ã‚’æœ‰åŠ¹ã«
    okBtn.className = 'modal-btn-danger';
    okBtn.textContent = 'å£²å´ã‚’è¨˜éŒ²ã™ã‚‹';
  };
  tabDelete.onclick = () => {
    mode = 'delete';
    tabDelete.className = 'sell-tab active-delete';
    tabSell.className   = 'sell-tab';
    sellForm.style.display  = 'none';
    deleteForm.style.display = '';
    okBtn.removeAttribute('style');
    okBtn.className = 'modal-btn-gray'; // ã‚°ãƒ¬ãƒ¼ç”¨ã‚¯ãƒ©ã‚¹ã«åˆ‡ã‚Šæ›¿ãˆ
    okBtn.textContent = 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‹ã‚‰å‰Šé™¤';
  };

  okBtn.onclick = async () => {
    const errEl = overlay.querySelector('#sm_err');
    errEl.textContent = '';
    okBtn.disabled = true;

    try {
      if (mode === 'sell') {
        const shares = parseInt(overlay.querySelector('#sm_shares').value, 10);
        const price  = parseFloat(overlay.querySelector('#sm_price').value);
        if (!shares || shares <= 0)       { errEl.textContent = 'æ ªæ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'; okBtn.disabled = false; return; }
        if (shares > maxShares)           { errEl.textContent = `ä¿æœ‰æ ªæ•°ï¼ˆ${maxShares}æ ªï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™`; okBtn.disabled = false; return; }
        if (isNaN(price) || price <= 0)   { errEl.textContent = 'å£²å´å˜ä¾¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'; okBtn.disabled = false; return; }

        const res = await fetch(`${RENDER_BASE}/api/portfolio/sell`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, shares, price }),
        });
        const j = await res.json();
        if (!res.ok) throw new Error(j.detail ?? 'å£²å´è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } else {
        // å…¥åŠ›ãƒŸã‚¹å‰Šé™¤: å…¨æ ªå£²å´ã¨ã—ã¦æ‰±ã†ï¼ˆprice=0ã¯ä¸å¯ãªã®ã§APIå´ã§å¯¾å¿œï¼‰
        const res = await fetch(`${RENDER_BASE}/api/portfolio/delete/${code}`, { method: 'DELETE' });
        if (!res.ok) {
          const j = await res.json().catch(() => ({}));
          throw new Error(j.detail ?? 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }
      close();
      await loadPortfolio();
    } catch(e) {
      errEl.textContent = e.message;
      okBtn.disabled = false;
    }
  };
}

// â”€â”€ åˆå›ãƒ­ãƒ¼ãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadAll();
</script>
</body>
</html>
